<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚓ Weather Engine Maritime - Dynamic Intelligence Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Premium Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&family=Poppins:wght@100;200;300;400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&family=Outfit:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Three.js and Vanta.js for dynamic backgrounds -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r121/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.topology.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.cells.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.topology.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.cells.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'],
                        'display': ['Space Grotesk', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        'body': ['Poppins', 'Inter', 'Helvetica', 'Arial', 'sans-serif'],
                        'modern': ['Outfit', 'Inter', 'Helvetica Neue', 'sans-serif'],
                        'helvetica': ['Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif']
                    },
                    colors: {
                        ocean: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        maritime: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    animation: {
                        'wave': 'wave 3s ease-in-out infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 3s infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        wave: {
                            '0%, 100%': { transform: 'rotate(0deg)' },
                            '50%': { transform: 'rotate(3deg)' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 5px #0ea5e9, 0 0 10px #0ea5e9, 0 0 15px #0ea5e9' },
                            '100%': { boxShadow: '0 0 10px #0ea5e9, 0 0 20px #0ea5e9, 0 0 30px #0ea5e9' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Hide scrollbar for all browsers */
        html {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }
        html::-webkit-scrollbar {
            width: 0; /* Chrome, Safari, and Opera */
            height: 0;
        }
        body {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* Internet Explorer 10+ */
        }
        body::-webkit-scrollbar {
            width: 0; /* Chrome, Safari, and Opera */
            height: 0;
        }
        
        .glass {
            background: rgba(22, 40, 56, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(63, 124, 172, 0.2);
        }
        .gradient-text {
            background: linear-gradient(45deg, #ffffff, #f0f9ff, #e0f2fe, #bae6fd);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 300% 300%;
            animation: gradient 3s ease infinite;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        /* Dynamic Text Animations */
        .dynamic-subtitle {
            background: linear-gradient(45deg, 
                #ffffff, #e0f2fe, #b3e5fc, #81d4fa, 
                #4fc3f7, #29b6f6, #03a9f4, #039be5);
            background-size: 400% 400%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: dynamicFlow 4s ease-in-out infinite;
            text-shadow: 0 4px 20px rgba(3, 169, 244, 0.3);
            filter: drop-shadow(0 2px 8px rgba(255, 255, 255, 0.1));
        }
        .dynamic-powered {
            background: linear-gradient(90deg, 
                #ffd700, #ffeb3b, #fff176, #ffffff, 
                #e1f5fe, #b3e5fc, #4fc3f7, #03a9f4);
            background-size: 600% 600%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: poweredFlow 5s ease-in-out infinite;
            text-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }
        @keyframes dynamicFlow {
            0%, 100% { 
                background-position: 0% 50%;
                transform: scale(1);
            }
            25% { 
                background-position: 25% 50%;
                transform: scale(1.02);
            }
            50% { 
                background-position: 100% 50%;
                transform: scale(1.04);
            }
            75% { 
                background-position: 75% 50%;
                transform: scale(1.02);
            }
        }  
        @keyframes poweredFlow {
            0%, 100% { 
                background-position: 0% 50%;
                filter: brightness(1) hue-rotate(0deg);
            }
            33% { 
                background-position: 50% 50%;
                filter: brightness(1.1) hue-rotate(30deg);
            }
            66% { 
                background-position: 100% 50%;
                filter: brightness(1.2) hue-rotate(60deg);
            }
        }       
        /* Exact Dark Ocean Background from Index.html */
        .bg-ocean-gradient {
            background: linear-gradient(135deg, 
                #001122 0%, 
                #002244 25%, 
                #003366 50%, 
                #002244 75%, 
                #001122 100%);
        }       
        /* Exact Animated Background from Index.html */
        .animated-bg {
            background: linear-gradient(-45deg, #001122, #002244, #003366, #004488);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }        
        .ocean-waves {
            background: linear-gradient(45deg, #0c4a6e, #075985, #0369a1, #0284c7);
            background-size: 400% 400%;
            animation: gradient 8s ease infinite;
        }
        .floating-particles {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #38bdf8;
            border-radius: 50%;
            animation: float 15s infinite linear;
            opacity: 0.6;
        }
        @keyframes float {
            0% { transform: translateY(100vh) translateX(0px); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100vh) translateX(100px); opacity: 0; }
        }
        .weather-card:hover {
            transform: translateY(-5px);
            transition: all 0.3s ease;
        }
        .metric-counter {
            font-variant-numeric: tabular-nums;
        }
        .map-glow {
            box-shadow: 0 0 50px rgba(14, 165, 233, 0.3);
        }
        .slider {
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #0ea5e9 0%, #22c55e 100%);
            outline: none;
            border-radius: 15px;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            border: 2px solid #0ea5e9;
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.5);
        }
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            border: 2px solid #0ea5e9;
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.5);
        }
        .route-line {
            animation: route-pulse 3s ease-in-out infinite;
        }
        @keyframes route-pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        .custom-marker {
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }
        .waypoint-marker {
            filter: drop-shadow(0 2px 4px rgba(6, 182, 212, 0.5));
        }
        @keyframes mapPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        .map-marker-pulse {
            animation: mapPulse 2s ease-in-out infinite;
        }
        @keyframes windFlow {
            0% { background-position: 0 0; }
            100% { background-position: 40px 40px; }
        }
        @keyframes waveMotion {
            0%, 100% { background-position: 0 0; }
            50% { background-position: 20px 20px; }
        }
        @keyframes vesselMove {
            0% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(20px) translateY(-10px); }
            50% { transform: translateX(-10px) translateY(15px); }
            75% { transform: translateX(15px) translateY(-5px); }
            100% { transform: translateX(0) translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        @keyframes windRipple {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        
        @keyframes circleGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.6); }
        }
        
        .elegant-wind-marker {
            z-index: 1000;
        }
        
        .elegant-wind-marker:hover .wind-dot {
            transform: translate(-50%, -50%) scale(1.3);
            box-shadow: 0 0 15px currentColor;
        }
        
        .elegant-wind-marker:hover .wind-direction-line {
            opacity: 1;
            width: 30px;
        }
        
        .elegant-tooltip {
            animation: tooltipFadeIn 0.3s ease-out;
        }
        
        @keyframes tooltipFadeIn {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .glow-circle {
            animation: circleGlow 3s ease-in-out infinite;
        }
        
        .pulse-animation {
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.9; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        /* Premium Card Effects & Modern Styling */
        .premium-card {
            background: rgba(22, 40, 56, 0.12);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(63, 124, 172, 0.25);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 1px 0 rgba(63, 124, 172, 0.15) inset,
                0 -1px 0 rgba(0, 0, 0, 0.3) inset;
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        .premium-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 20px 60px rgba(63, 124, 172, 0.25),
                0 8px 32px rgba(0, 0, 0, 0.5),
                0 1px 0 rgba(63, 124, 172, 0.3) inset;
            border-color: rgba(63, 124, 172, 0.4);
        }
        .neo-glass {
            background: linear-gradient(135deg, 
                rgba(22, 40, 56, 0.18) 0%, 
                rgba(12, 30, 38, 0.08) 100%);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(63, 124, 172, 0.3);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.35),
                inset 0 1px 0 rgba(63, 124, 172, 0.2),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
        }
        .gradient-border {
            position: relative;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 16px;
            padding: 2px;
        }
        .gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            padding: 2px;
            background: linear-gradient(135deg, #0ea5e9, #06b6d4, #3b82f6, #8b5cf6);
            border-radius: inherit;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            animation: gradient-rotation 3s linear infinite;
        }
        @keyframes gradient-rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modern-button {
            background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            letter-spacing: 0.025em;
            box-shadow: 
                0 4px 15px rgba(14, 165, 233, 0.4),
                0 1px 3px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .modern-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .modern-button:hover::before {
            left: 100%;
        }
        .modern-button:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(14, 165, 233, 0.5),
                0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .premium-text {
            font-family: 'Helvetica Neue', 'Space Grotesk', sans-serif;
            font-weight: 500;
            letter-spacing: -0.02em;
            line-height: 1.3;
        }
        .modern-heading {
            font-family: 'Helvetica Neue', 'Inter', sans-serif;
            font-weight: 700;
            letter-spacing: -0.04em;
            line-height: 1.1;
        }
        .elegant-subtext {
            font-family: 'Helvetica Neue', 'Poppins', sans-serif;
            font-weight: 400;
            letter-spacing: 0.01em;
            line-height: 1.6;
        }
        /* Enhanced Interactive Elements */
        .interactive-card {
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            cursor: pointer;
        }
        .interactive-card:hover {
            transform: translateY(-5px) rotateX(5deg);
            box-shadow: 
                0 20px 40px rgba(14, 165, 233, 0.2),
                0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .glow-effect {
            position: relative;
        }
        .glow-effect::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            opacity: 0;
            background: linear-gradient(135deg, #0ea5e9, #06b6d4);
            filter: blur(20px);
            z-index: -1;
            transition: opacity 0.3s ease;
        }
        .glow-effect:hover::after {
            opacity: 0.3;
        }
        /* Enhanced Dynamic Background - RE-ENABLED WITH TOPOLOGY */
        .vanta-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 1 !important;
            display: block !important;
            background: transparent !important;
        }
        /* Low-Poly Background Base */
        .low-poly-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: linear-gradient(135deg, #0a1929 0%, #162838 30%, #1a2332 60%, #0f1b28 100%);
        }
        .geometric-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            background: 
                radial-gradient(circle at 15% 25%, rgba(74, 144, 226, 0.05) 0%, transparent 40%),
                radial-gradient(circle at 85% 75%, rgba(107, 182, 255, 0.04) 0%, transparent 35%),
                radial-gradient(circle at 45% 60%, rgba(26, 84, 144, 0.03) 0%, transparent 45%);
            opacity: 0.5;
        }
        .enhanced-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }
        .enhanced-particles::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 200%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.15), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(14, 165, 233, 0.2), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(6, 182, 212, 0.25), transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(59, 130, 246, 0.2), transparent);
            background-repeat: repeat;
            background-size: 150px 150px;
            animation: float-particles 20s linear infinite;
        }
        @keyframes float-particles {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(-200px) rotate(360deg); }
        }
        /* Additional Low-Poly CSS Enhancements */
        .polygon-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -3;
            overflow: hidden;
        }
        .polygon {
            position: absolute;
            background: linear-gradient(135deg, rgba(63, 124, 172, 0.1), rgba(41, 98, 149, 0.05));
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            animation: float-polygon 20s infinite linear;
        }
        .polygon:nth-child(1) {
            width: 200px;
            height: 200px;
            top: 10%;
            left: 15%;
            animation-delay: 0s;
            background: linear-gradient(135deg, rgba(52, 109, 158, 0.08), rgba(63, 124, 172, 0.04));
        }
        .polygon:nth-child(2) {
            width: 150px;
            height: 150px;
            top: 60%;
            right: 20%;
            animation-delay: -5s;
            clip-path: polygon(25% 0%, 100% 0%, 75% 100%, 0% 100%);
            background: linear-gradient(135deg, rgba(41, 98, 149, 0.06), rgba(52, 109, 158, 0.03));
        }
        .polygon:nth-child(3) {
            width: 120px;
            height: 120px;
            top: 30%;
            right: 10%;
            animation-delay: -10s;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            background: linear-gradient(135deg, rgba(63, 124, 172, 0.05), rgba(41, 98, 149, 0.02));
        }
        @keyframes float-polygon {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.6; }
        }
        /* Custom Scrollbar Styles */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(59, 130, 246, 0.7) rgba(15, 23, 42, 0.3);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(
                180deg,
                rgba(59, 130, 246, 0.8) 0%,
                rgba(37, 99, 235, 0.9) 50%,
                rgba(29, 78, 216, 1) 100%
            );
            border-radius: 10px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.2);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(
                180deg,
                rgba(99, 179, 237, 0.9) 0%,
                rgba(59, 130, 246, 1) 50%,
                rgba(37, 99, 235, 1) 100%
            );
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:active {
            background: linear-gradient(
                180deg,
                rgba(29, 78, 216, 1) 0%,
                rgba(37, 99, 235, 1) 50%,
                rgba(59, 130, 246, 1) 100%
            );
        }
        /* Alternative Maritime Theme Scrollbar */
        .maritime-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: rgba(6, 182, 212, 0.7) rgba(8, 47, 73, 0.4);
        }
        .maritime-scrollbar::-webkit-scrollbar {
            width: 10px;
        }
        .maritime-scrollbar::-webkit-scrollbar-track {
            background: rgba(8, 47, 73, 0.4);
            border-radius: 12px;
            border: 1px solid rgba(6, 182, 212, 0.2);
        }
        .maritime-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(
                45deg,
                rgba(6, 182, 212, 0.8) 0%,
                rgba(14, 165, 233, 0.9) 25%,
                rgba(2, 132, 199, 1) 50%,
                rgba(3, 105, 161, 1) 75%,
                rgba(7, 89, 133, 1) 100%
            );
            border-radius: 12px;
            border: 1px solid rgba(6, 182, 212, 0.4);
            box-shadow: 
                0 2px 4px rgba(6, 182, 212, 0.3),
                inset 0 1px 2px rgba(255, 255, 255, 0.1);
        }
        .maritime-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(
                45deg,
                rgba(34, 211, 238, 0.9) 0%,
                rgba(6, 182, 212, 1) 25%,
                rgba(14, 165, 233, 1) 50%,
                rgba(2, 132, 199, 1) 75%,
                rgba(3, 105, 161, 1) 100%
            );
            box-shadow: 
                0 4px 8px rgba(6, 182, 212, 0.4),
                inset 0 1px 2px rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        .maritime-scrollbar::-webkit-scrollbar-thumb:active {
            background: linear-gradient(
                45deg,
                rgba(3, 105, 161, 1) 0%,
                rgba(7, 89, 133, 1) 25%,
                rgba(14, 165, 233, 1) 50%,
                rgba(6, 182, 212, 1) 75%,
                rgba(34, 211, 238, 1) 100%
            );
        }
        /* Alert Popup Notifications */
        .alert-popup-container {
            position: fixed;
            z-index: 1000;
            max-width: 350px;
            transition: all 0.3s ease-in-out;
        }
        .alert-popup-container.top-right {
            top: 20px;
            right: 20px;
        }
        .alert-popup-container.bottom-right {
            bottom: 20px;
            right: 20px;
        }
        .alert-popup {
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.3),
                0 0 20px rgba(59, 130, 246, 0.1);
            transform: translateX(400px);
            opacity: 0;
            animation: slideInAlert 0.5s ease-out forwards;
        }
        .alert-popup.show {
            transform: translateX(0);
            opacity: 1;
        }
        .alert-popup.hide {
            animation: slideOutAlert 0.3s ease-in forwards;
        }
        @keyframes slideInAlert {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOutAlert {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        .alert-popup .close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #ef4444;
            transition: all 0.2s ease;
        }
        .alert-popup .close-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }
        /* Position Toggle Button */
        .position-toggle {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            padding: 6px 10px;
            color: #3b82f6;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
        }
        .position-toggle:hover {
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="animated-bg text-white font-helvetica overflow-x-hidden" style="font-family: 'Helvetica Neue', 'Inter', 'Helvetica', sans-serif;">
    <!-- Alert Popup Container -->
    <div id="alertPopupContainer" class="alert-popup-container top-right"></div>
    <!-- Low-Poly Dynamic Background -->
    <div class="polygon-shapes">
        <div class="polygon"></div>
        <div class="polygon"></div>
        <div class="polygon"></div>
    </div>
    <div class="low-poly-bg"></div>
    <div id="vanta-background" class="vanta-background"></div>
    <div class="geometric-overlay"></div>
    <div class="enhanced-particles"></div>
    <!-- Floating Particles Animation -->
    <div class="fixed inset-0 pointer-events-none">
        <div class="floating-particles" style="left: 10%; animation-delay: 0s;"></div>
        <div class="floating-particles" style="left: 20%; animation-delay: 2s;"></div>
        <div class="floating-particles" style="left: 30%; animation-delay: 4s;"></div>
        <div class="floating-particles" style="left: 40%; animation-delay: 6s;"></div>
        <div class="floating-particles" style="left: 50%; animation-delay: 8s;"></div>
        <div class="floating-particles" style="left: 60%; animation-delay: 10s;"></div>
        <div class="floating-particles" style="left: 70%; animation-delay: 12s;"></div>
        <div class="floating-particles" style="left: 80%; animation-delay: 14s;"></div>
        <div class="floating-particles" style="left: 90%; animation-delay: 16s;"></div>
    </div>
    <!-- Navigation Bar -->
    <nav class="glass fixed top-0 left-0 right-0 z-50 p-2" data-aos="fade-down">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-anchor text-lg animate-wave text-ocean-300"></i>
                <span class="text-lg font-bold gradient-text">Weather Engine Maritime</span>
            </div>
            <div class="flex items-center space-x-3">
                <div id="liveTime" class="glass px-2 py-1 rounded-lg border border-ocean-300/30 bg-ocean-900/20 backdrop-blur-sm text-sm"></div>
                <div class="pl-5 flex items-center space-x-2">
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    <span class="text-xs">Live System</span>
                </div>
            </div>
        </div>
    </nav>
    <div class="container mx-auto px-6 py-24">
        <!-- Hero Section -->
        <div class="text-center mb-16" data-aos="zoom-in" data-aos-duration="1000">
            <h1 class="text-6xl md:text-8xl font-black mb-6 animate-float modern-heading">
                <span class="gradient-text" style="font-family: 'Helvetica Neue', 'Space Grotesk', sans-serif;">⚓ MARITIME</span>
                <br>
                <span class="text-white" style="font-family: 'Helvetica Neue', 'Space Grotesk', sans-serif;">INTELLIGENCE</span>
            </h1>
            <p class="text-2xl md:text-4xl lg:text-5xl text-ocean-200 mb-8 max-w-6xl mx-auto leading-relaxed elegant-subtext">
                <span class="dynamic-subtitle font-bold tracking-wide">
                    Real-time Weather Intelligence • Route Optimization • Maritime Safety
                </span>
                <br><br>
                <span class="dynamic-powered text-xl md:text-2xl lg:text-3xl font-semibold tracking-wider">
                    Powered by Advanced Physics & AI Algorithms
                </span>
            </p>
            <div>
                <div id="mockBanner" class="mt-6 bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30 px-8 py-4 rounded-2xl inline-block">
                    <div class="flex flex-row items-center space-x-6">
                        <div class="flex flex-col">
                            <span class="text-md text-yellow-300 text-left block">PostgreSQL</span>
                            <span class="text-lg font-semibold mr-2">Connectivity Status</span>
                        </div>
                        <span class="text-lg text-green-400 flex items-center" id="dbStatus">
                            <i class="fas fa-check mr-1 text-green-400"></i>
                            Online
                        </span>
                    </div>
                </div>
            </div>       
        </div>
        <!-- Live Metrics Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
            <div class="premium-card interactive-card rounded-2xl p-6 text-center weather-card bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30" data-aos="fade-up" data-aos-delay="100">
                <div class="text-4xl mb-2">🌊</div>
                <div class="text-2xl font-bold metric-counter premium-text" id="waveHeight">2.4m</div>
                <div class="text-ocean-300 elegant-subtext">Wave Height</div>
                <div class="mt-2 text-sm text-green-400">
                    <i class="fas fa-arrow-down mr-1"></i>Decreasing
                </div>
            </div>
            <div class="premium-card interactive-card rounded-2xl p-6 text-center weather-card bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30" data-aos="fade-up" data-aos-delay="200">
                <div class="text-4xl mb-2">💨</div>
                <div class="text-2xl font-bold metric-counter premium-text" id="windSpeed">12.8 kts</div>
                <div class="text-ocean-300 elegant-subtext">Wind Speed</div>
                <div class="mt-2 text-sm text-yellow-400">
                    <i class="fas fa-arrow-right mr-1"></i>Stable
                </div>
            </div>
            <div class="premium-card interactive-card rounded-2xl p-6 text-center weather-card bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30" data-aos="fade-up" data-aos-delay="300">
                <div class="text-4xl mb-2">⛽</div>
                <div class="text-2xl font-bold metric-counter premium-text text-green-400" id="fuelSavings">15.3%</div>
                <div class="text-ocean-300 elegant-subtext">Fuel Savings</div>
                <div class="mt-2 text-sm text-green-400">
                    <i class="fas fa-arrow-up mr-1"></i>Optimized
                </div>
            </div>
            <div class="premium-card interactive-card rounded-2xl p-6 text-center weather-card bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30" data-aos="fade-up" data-aos-delay="400">
                <div class="text-4xl mb-2">🚨</div>
                <div class="text-2xl font-bold metric-counter premium-text" id="alertCount">0</div>
                <div class="text-ocean-300 elegant-subtext">Active Alerts</div>
                <div class="mt-2 text-sm text-green-400">
                    <i class="fas fa-check mr-1"></i>All Clear
                </div>
            </div>
        </div>
        <!-- API Status Panel -->
        <div class="premium-card bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30 rounded-2xl p-6 mb-12" data-aos="fade-up">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold flex items-center">
                    <i class="fas fa-server mr-3 text-ocean-400"></i>
                    System Status
                </h2>
                <button id="refreshStatus" class="glass px-4 py-2 rounded-lg hover:bg-white/10 transition-all">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="flex items-center justify-between p-4 bg-slate-800 border border-yellow-400/30 rounded-xl">
                    <div>
                        <div class="text-sm text-yellow-300">Backend API</div>
                        <div class="text-lg font-semibold">Port 8000</div>
                    </div>
                    <div id="apiStatus" class="text-red-400 flex items-center">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Checking...
                    </div>
                </div>
                <div class="flex items-center justify-between p-4 bg-slate-800 border border-yellow-400/30 rounded-xl">
                    <div>
                        <div class="text-sm text-yellow-300">Route Data</div>
                        <div class="text-lg font-semibold">Mumbai → Kochi</div>
                    </div>
                    <div id="routeStatus" class="text-green-400 flex items-center">
                        <i class="fas fa-check mr-2"></i>Loaded
                    </div>
                </div>
                <div class="flex items-center justify-between p-4 bg-slate-800 border border-yellow-400/30 rounded-xl">
                    <div>
                        <div class="text-sm text-yellow-300">Weather Data</div>
                        <div class="text-lg font-semibold">10-day Forecast</div>
                    </div>
                    <div id="weatherStatus" class="text-green-400 flex items-center">
                        <i class="fas fa-cloud mr-2"></i>Active
                    </div>
                </div>
            </div>
        </div>
        <!-- Port Selection Panel -->
        <div class="bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30 rounded-2xl p-6 mb-8" data-aos="zoom-in">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-anchor mr-3 text-yellow-400"></i>
                Route Configuration
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Source Port -->
                <div class="space-y-3">
                    <label class="block text-sm font-semibold text-ocean-200">
                        <i class="fas fa-ship mr-2 text-green-400"></i>Departure Port
                    </label>
                    <select id="sourcePort" class="w-full glass rounded-xl px-4 py-3 text-white bg-white/10 border border-white/20 focus:border-ocean-400 focus:ring-2 focus:ring-ocean-400/50 transition-all">
                        <option class="text-black" value="gopalpur">🇮🇳 Gopalpur Port (INGOP)</option>
                        <option class="text-black" value="rotterdam">🇳🇱 Rotterdam Port (NLRTM)</option>
                    </select>
                </div>
                <!-- Destination Port -->
                <div class="space-y-3">
                    <label class="block text-sm font-semibold text-ocean-200">
                        <i class="fas fa-flag-checkered mr-2 text-red-400"></i>Destination Port
                    </label>
                    <select id="destinationPort" class="w-full glass rounded-xl px-4 py-3 text-white bg-white/10 border border-white/20 focus:border-ocean-400 focus:ring-2 focus:ring-ocean-400/50 transition-all">
                        <option class="text-black" value="newharbour" selected>🇺🇸 New Harbour (INNH)</option>
                        <option class="text-black" value="singapore">🇸🇬 Singapore Port (SGSIN)</option>
                    </select>
                </div>
            </div>     
            <!-- Route Info Display -->
            <div class="mt-6 glass rounded-xl p-4 bg-gradient-to-r from-ocean-800/50 to-cyan-800/50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="text-center">
                            <div class="text-xs text-ocean-300">Distance</div>
                            <div id="routeDistance" class="text-lg font-bold text-cyan-400">1,247 nm</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-ocean-300">Est. Duration</div>
                            <div id="routeDuration" class="text-lg font-bold text-yellow-400">52h 18m</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-ocean-300">Fuel Cost</div>
                            <div id="fuelCost" class="text-lg font-bold text-green-400">$24,590</div>
                        </div>
                    </div>
                    <button id="updateRoute" class="bg-gradient-to-r from-purple-600 to-indigo-500 hover:from-purple-700 hover:to-indigo-600 px-6 py-2 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105 flex items-center">
                        <i class="fas fa-route mr-2"></i>Update Route
                    </button>
                </div>
            </div>
        </div>
        <!-- Main Dashboard -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            <!-- Interactive Map Panel -->
            <div class="xl:col-span-2 bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30 rounded-2xl p-6" data-aos="fade-right">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold flex items-center">
                        <i class="fas fa-map mr-3 text-yellow-400"></i>
                        Interactive Route Map
                        <span id="currentRoute" class="ml-3 text-sm px-3 py-1 bg-gradient-to-r from-green-500/20 to-cyan-500/20 rounded-full border border-green-400/30">
                            Mumbai → Kochi
                        </span>
                    </h2>
                    <div class="flex space-x-2">
                        <button id="centerMap" class="glass px-3 py-2 rounded-lg text-sm hover:bg-white/10 transition-all">
                            <i class="fas fa-crosshairs mr-1"></i>Center
                        </button>
                        <button id="fullscreen" class="glass px-3 py-2 rounded-lg text-sm hover:bg-white/10 transition-all">
                            <i class="fas fa-expand mr-1"></i>Fullscreen
                        </button>
                        <button id="3dView" class="glass px-3 py-2 rounded-lg text-sm hover:bg-white/10 transition-all">
                            <i class="fas fa-cube mr-1"></i>3D View
                        </button>
                    </div>
                </div>
                <div id="map" class="h-96 xl:h-[500px] rounded-xl map-glow relative overflow-hidden bg-gray-900">
                    <!-- Map Loading Overlay -->
                    <div id="mapLoader" class="absolute inset-0 bg-gradient-to-br from-ocean-800 to-ocean-900 z-20 flex items-center justify-center">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto mb-4"></div>
                            <div class="text-cyan-300 mb-2">Loading Interactive Map...</div>
                            <div class="text-xs text-ocean-400">Initializing satellite view</div>
                        </div>
                    </div>                   
                    <!-- Fallback Map Content -->
                    <div id="mapFallback" class="absolute inset-0 bg-gradient-to-br from-blue-900 via-blue-800 to-green-800 z-10 hidden">
                        <div class="absolute inset-0 opacity-30">
                            <svg viewBox="0 0 100 100" class="w-full h-full">
                                <!-- Ocean waves pattern -->
                                <defs>
                                    <pattern id="waves" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                                        <path d="M0,10 Q5,5 10,10 T20,10" stroke="rgba(14, 165, 233, 0.3)" stroke-width="0.5" fill="none"/>
                                        <path d="M0,15 Q5,10 10,15 T20,15" stroke="rgba(6, 182, 212, 0.2)" stroke-width="0.3" fill="none"/>
                                    </pattern>
                                </defs>
                                <rect width="100" height="100" fill="url(#waves)"/>
                            </svg>
                        </div>                      
                        <!-- Route visualization -->
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="relative w-full h-full max-w-md max-h-md">
                                <!-- Mumbai marker -->
                                <div class="absolute top-1/4 left-1/4 w-4 h-4 bg-green-500 rounded-full border-2 border-white animate-pulse shadow-lg">
                                    <div class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs text-white bg-black/50 px-2 py-1 rounded whitespace-nowrap">
                                        🇮🇳 Mumbai
                                    </div>
                                </div>                           
                                <!-- Kochi marker -->
                                <div class="absolute bottom-1/4 right-1/4 w-4 h-4 bg-red-500 rounded-full border-2 border-white animate-pulse shadow-lg">
                                    <div class="absolute -top-8 left-1/2 transform -translate-x-1/2 text-xs text-white bg-black/50 px-2 py-1 rounded whitespace-nowrap">
                                        🇮🇳 Kochi
                                    </div>
                                </div>                            
                                <!-- Route line -->
                                <svg class="absolute inset-0 w-full h-full">
                                    <defs>
                                        <linearGradient id="routeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#22c55e;stop-opacity:0.8" />
                                            <stop offset="100%" style="stop-color:#ef4444;stop-opacity:0.8" />
                                        </linearGradient>
                                    </defs>
                                    <path d="M25,25 Q50,15 75,75" stroke="url(#routeGradient)" stroke-width="3" fill="none" stroke-dasharray="5,5" class="animate-pulse"/>
                                </svg>                          
                                <!-- Waypoints -->
                                <div class="absolute top-1/3 left-1/2 w-2 h-2 bg-cyan-400 rounded-full animate-ping"></div>
                                <div class="absolute top-2/3 right-1/3 w-2 h-2 bg-cyan-400 rounded-full animate-ping" style="animation-delay: 0.5s;"></div>
                            </div>
                        </div>                  
                        <!-- Map info overlay -->
                        <div class="absolute bottom-4 left-4 right-4">
                            <div class="glass rounded-lg p-3 text-center">
                                <div class="text-sm font-semibold text-white mb-1">📍 Route Visualization</div>
                                <div class="text-xs text-cyan-300">Mumbai → Kochi Maritime Route</div>
                                <div class="text-xs text-ocean-300 mt-1">Distance: ~1,247 nautical miles</div>
                            </div>
                        </div>
                    </div>                    
                    <!-- Map overlay gradient -->
                    <div class="absolute inset-0 bg-gradient-to-r from-ocean-900/10 to-transparent z-30 pointer-events-none"></div>
                </div>              
                <!-- Advanced Map Controls -->
                <div class="mt-6 space-y-4">
                    <!-- Weather Overlay Controls -->
                    <div class="flex flex-wrap gap-3">
                        <button id="waveOverlayBtn" class="overlay-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl">
                            <span class="text-lg">🌊</span>
                            <span>Wave Zones</span>
                            <div class="loading-spinner hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin ml-2"></div>
                        </button>
                        <button id="windOverlayBtn" class="overlay-btn bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl">
                            <span class="text-lg">🌪️</span>
                            <span>Wind Arrows</span>
                            <div class="loading-spinner hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin ml-2"></div>
                        </button>
                        <button id="tempOverlayBtn" class="overlay-btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl">
                            <span class="text-lg">🌡️</span>
                            <span>Temperature</span>
                            <div class="loading-spinner hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin ml-2"></div>
                        </button>
                        <button id="precipOverlayBtn" class="overlay-btn bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl">
                            <span class="text-lg">🌧️</span>
                            <span>Precipitation</span>
                            <div class="loading-spinner hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin ml-2"></div>
                        </button>
                        <button id="clearOverlayBtn" class="overlay-btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center gap-2 shadow-lg hover:shadow-xl">
                            <span class="text-lg">🗑️</span>
                            <span>Clear All</span>
                        </button>
                    </div>                
                    <!-- Map Statistics -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 pb-5">
                        <div class="glass rounded-lg p-3 text-center">
                            <div class="text-xs text-ocean-300">Zoom Level</div>
                            <div id="mapZoom" class="text-sm font-bold text-cyan-400">7</div>
                        </div>
                        <div class="glass rounded-lg p-3 text-center">
                            <div class="text-xs text-ocean-300">Map Type</div>
                            <div id="mapType" class="text-sm font-bold text-cyan-200">Satellite</div>
                        </div>
                        <div class="glass rounded-lg p-3 text-center">
                            <div class="text-xs text-ocean-300">Active Layers</div>
                            <div id="activeLayers" class="text-sm font-bold text-green-400">0</div>
                        </div>
                        <div class="glass rounded-lg p-3 text-center">
                            <div class="text-xs text-ocean-300">Vessels Visible</div>
                            <div id="visibleVessels" class="text-sm font-bold text-yellow-400">3</div>
                        </div>
                    </div>
                </div>
                <hr class="my-6 pb-6">
                <!-- Advanced Weather Panel -->
                <div class="bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30 rounded-2xl mt-6 p-6 weather-card" data-aos="fade-left" data-aos-delay="100">
                    <h3 class="text-xl font-bold mb-4 flex items-center justify-between">
                        <span class="flex items-center">
                            <i class="fas fa-cloud-sun mr-3 text-yellow-400"></i>
                            Charts & Data Observation
                        </span>
                        <div class="flex items-center space-x-2 text-xs">
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                            <span class="text-green-400">Live</span>
                        </div>
                    </h3>                   
                    <!-- Weather Control Buttons -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button id="loadForecast" class="modern-button premium-text">
                            <i class="fas fa-download mr-2"></i>
                            Load Forecast
                        </button>
                        <button id="refreshWeather" class="modern-button premium-text" style="background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Refresh
                        </button>
                    </div>            
                    <!-- Weather Timeline Selector -->
                    <div class="mb-4">
                        <label class="block text-xs font-semibold text-ocean-200 mb-2">Forecast Timeline</label>
                        <select id="weatherTimeline" class="w-full glass rounded-lg px-3 py-2 text-sm text-white bg-white/10 border border-white/20 focus:border-ocean-400">
                            <option class="text-black" value="6h">Next 6 Hours</option>
                            <option class="text-black" value="24h" selected>Next 24 Hours</option>
                            <option class="text-black" value="72h">Next 3 Days</option>
                            <option class="text-black" value="168h">Next 7 Days</option>
                        </select>
                    </div>            
                    <div id="forecastData" class="text-sm text-ocean-200 mb-4">
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-ocean-300">Current Conditions:</span>
                                <span class="text-cyan-400">Loading...</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ocean-300">Wind Speed:</span>
                                <span id="currentWind" class="text-yellow-400">12.8 kts</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ocean-300">Wave Height:</span>
                                <span id="currentWaves" class="text-cyan-200">2.4m</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ocean-300">Visibility:</span>
                                <span id="currentVisibility" class="text-green-400">15.2 km</span>
                            </div>
                        </div>
                    </div>     
                    <!-- Enhanced Weather Chart -->
                    <div class="bg-black/20 rounded-lg p-3 mb-4">
                        <canvas id="weatherChart" class="w-full h-32"></canvas>
                    </div>
                    
                </div>
            </div>
            <!-- Control Panel -->
            <div class="space-y-6">
                <!-- Advanced Speed Settings Panel -->
                <div class="bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30 rounded-2xl p-6 weather-card" data-aos="fade-left" data-aos-delay="200">
                    <h3 class="text-xl font-bold mb-4 flex items-center justify-between">
                        <span class="flex items-center">
                            <i class="fas fa-tachometer-alt mr-3 text-yellow-400"></i>
                            Route Settings
                        </span>
                    </h3>               
                    <!-- Settings Parameters -->
                    <div class="space-y-3 mb-4">
                        <div class="flex items-center justify-between">
                            <label class="block text-xs font-semibold text-ocean-200 mb-1" for="fuelPrice">Fuel Price ($/MT)</label>
                            <input type="number" id="fuelPrice" value="650" min="400" max="1200" step="10" class="w-24 px-3 py-2 text-sm text-white bg-slate-800/50 border border-ocean-400/30 rounded-lg backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-ocean-400 focus:border-ocean-400 transition-all duration-300 hover:bg-slate-700/50 hover:border-ocean-300/50">
                        </div>
                        <hr class="border-ocean-400/20 border-t my-3">
                        <div class="flex items-center justify-between">
                            <label class="block text-xs font-semibold text-ocean-200 mb-1" for="fuelConsumption">Fuel Consumption (L/100nm)</label>
                            <input type="number" id="fuelConsumption" value="3200" min="2000" max="10000" step="100" class="w-24 px-3 py-2 text-sm text-white bg-slate-800/50 border border-ocean-400/30 rounded-lg backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-ocean-400 focus:border-ocean-400 transition-all duration-300 hover:bg-slate-700/50 hover:border-ocean-300/50">
                        </div>
                        <hr class="border-ocean-400/20 border-t my-3">
                        <div class="h-6"></div>
                        <div>
                            <label class="block text-xs font-semibold text-ocean-200 mb-1">Max Speed Limit</label>
                            <input type="range" id="speedLimit" min="8" max="35" value="18" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                            <div class="flex justify-between text-xs text-ocean-300 mt-1">
                                <span>8 kts</span>
                                <span id="speedValue" class="text-green-400 font-bold text-lg bg-green-400/10 px-3 py-1 mt-2 rounded-lg shadow-lg">18 kts</span>
                                <span>35 kts</span>
                            </div>
                        </div>
                    </div>                
                    <!-- Space above speed profile -->
                    <div class="h-6"></div>
                    <div class="h-6"></div>
                    <div class="h-6"></div>
                    <div class="h-6"></div>

                    
                    <button id="optimizeRoute" class="w-full bg-gradient-to-r from-green-600 to-emerald-500 hover:from-green-700 hover:to-emerald-600 px-6 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 mb-4 flex items-center justify-center">
                        <i class="fas fa-rocket mr-2"></i>
                        <span id="optimizeText">Optimize Speed Profile</span>
                    </button>              
                   
                    
                </div>
                <!-- Enhanced Alerts Panel -->
                <div class="bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30 rounded-2xl p-6 weather-card" data-aos="fade-left" data-aos-delay="300">
                    <h3 class="text-xl font-bold mb-4 flex items-center justify-between">
                        <span class="flex items-center">
                            <i class="fas fa-shield-alt mr-3 text-yellow-400"></i>
                            Safety & Alerts
                        </span>
                        <div id="alertBadge" class="text-xs px-2 py-1 bg-green-500/20 rounded-full border border-green-400/30 text-green-400">
                            All Clear
                        </div>
                    </h3>                
                    <!-- Popup Position Toggle -->
                    <div class="mb-4 flex items-center justify-between">
                        <span class="text-sm text-ocean-300">Alert Notifications:</span>
                        <div id="positionToggle" class="position-toggle">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            <span id="positionText">Top Right</span>
                        </div>
                    </div>                
                    <!-- Alert Types Selector -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button id="weatherAlerts" class="glass px-3 py-2 rounded-lg text-xs flex items-center justify-center border border-yellow-500/50 relative" data-type="weather">
                            <i class="fas fa-cloud-bolt mr-1 text-yellow-400"></i>
                            Weather
                            <span class="checkmark absolute right-2 top-2 hidden"><i class="fas fa-check text-green-500"></i></span>
                        </button>
                        <button id="navigationAlerts" class="glass px-3 py-2 rounded-lg text-xs flex items-center justify-center border border-cyan-200/50 relative" data-type="navigation">
                            <i class="fas fa-compass mr-1 text-cyan-200"></i>
                            Navigation
                            <span class="checkmark absolute right-2 top-2 hidden"><i class="fas fa-check text-green-500"></i></span>
                        </button>
                        <button id="securityAlerts" class="glass px-3 py-2 rounded-lg text-xs flex items-center justify-center border border-red-400/50 relative" data-type="security">
                            <i class="fas fa-lock mr-1 text-red-400"></i>
                            Security
                            <span class="checkmark absolute right-2 top-2 hidden"><i class="fas fa-check text-green-500"></i></span>
                        </button>
                        <button id="mechanicalAlerts" class="glass px-3 py-2 rounded-lg text-xs flex items-center justify-center border border-gray-400/50 relative" data-type="mechanical">
                            <i class="fas fa-cog mr-1 text-gray-400"></i>
                            Mechanical
                            <span class="checkmark absolute right-2 top-2 hidden"><i class="fas fa-check text-green-500"></i></span>
                        </button>
                    </div>                    
                    <button id="loadAlerts" class="w-full bg-gradient-to-r from-red-600 to-orange-500 hover:from-red-700 hover:to-orange-600 px-6 py-3 rounded-xl font-semibold transition-all duration-300 transform hover:scale-105 mb-4 flex items-center justify-center">
                        <i class="fas fa-search mr-2"></i>
                        Scan for Alerts
                    </button>                    
                    <div id="alertsData" class="text-sm text-ocean-200 space-y-2">
                        <div class="flex items-center justify-center py-6 text-green-400">
                            <i class="fas fa-check-circle mr-2"></i>
                            No active alerts detected
                        </div>
                    </div>                    
                    <!-- Alert Statistics -->
                    <div class="mt-4 grid grid-cols-2 gap-3 text-xs">
                        <div class="glass rounded-lg p-2 text-center">
                            <div class="text-yellow-400 font-bold" id="warningCount">0</div>
                            <div class="text-ocean-300">Warnings</div>
                        </div>
                        <div class="glass rounded-lg p-2 text-center">
                            <div class="text-red-400 font-bold" id="criticalCount">0</div>
                            <div class="text-ocean-300">Critical</div>
                        </div>
                    </div>
                </div>                
                <!-- Waypoint Weather Data -->
                <div class="bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30 rounded-2xl p-6 weather-card" data-aos="fade-left" data-aos-delay="400">
                    <h3 class="text-xl font-bold mb-4 flex items-center justify-between">
                        <span class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-3 text-yellow-400"></i>
                            Waypoint Weather Data
                        </span>
                        <button id="refreshWaypointWeatherMain" class="text-xs px-3 py-1 bg-cyan-600/20 hover:bg-cyan-600/30 text-cyan-400 rounded border border-cyan-600/30 transition-colors" title="Refresh waypoint weather data">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh
                        </button>
                    </h3>
                    
                    <div class="h-4"></div>
                    <div class="h-4"></div>
                    <div class="h-4"></div>
                    <div class="h-3"></div>

                    
                    <div id="waypointWeatherContainerMain" class="max-h-64 overflow-y-auto maritime-scrollbar">
                        <div id="waypointWeatherDataMain" class="space-y-2 text-sm">
                            <div class="text-center text-ocean-300 py-8">
                                <i class="fas fa-route text-4xl mb-4 opacity-50"></i>
                                <p>Generate a route to view waypoint weather data</p>
                                <p class="text-xs mt-2 opacity-75">Weather conditions will be displayed for each navigation point</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Advanced Analytics and Visualization Section -->
        <div class="mt-12 space-y-8">
            <!-- Real-time Data Dashboard -->
            <div class="bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30 rounded-2xl p-8" data-aos="fade-up">
                <h2 class="text-3xl font-bold mb-8 flex items-center">
                    <i class="fas fa-chart-area mr-4 text-yellow-400"></i>
                    <span class="gradient-text">Advanced Analytics Dashboard</span>
                </h2>
                
                <!-- Environmental Impact Comparison Chart -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
                    <!-- Before/After Comparison -->
                    <div class="bg-black/30 rounded-xl p-6 border border-ocean-700/30">
                        <h3 class="text-xl font-semibold mb-6 flex items-center justify-between">
                            <span class="flex items-center">
                                <i class="fas fa-balance-scale mr-3 text-cyan-400"></i>
                                Route Performance Comparison
                            </span>
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-red-400 rounded-full"></div>
                                <span class="text-xs text-red-300">Base Route</span>
                                <div class="w-3 h-3 bg-green-400 rounded-full ml-4"></div>
                                <span class="text-xs text-green-300">Actual Route</span>
                            </div>
                        </h3>
                        
                        <!-- Comparison Metrics -->
                        <div class="space-y-4">
                            <!-- Travel Time -->
                            <div class="p-4 bg-slate-800/40 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm font-medium text-ocean-300">Travel Time</span>
                                    <span class="text-xs text-green-400">-17% improvement</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="text-center">
                                        <div id="baseRouteDuration" class="text-red-400 font-bold text-lg">52h 18m</div>
                                        <div class="text-xs text-red-300">Without optimization</div>
                                    </div>
                                    <div class="text-center">
                                        <div id="optimizedRouteDuration" class="text-green-400 font-bold text-lg">43h 25m</div>
                                        <div class="text-xs text-green-300">With wind/current data</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Fuel Consumption -->
                            <div class="p-4 bg-slate-800/40 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm font-medium text-ocean-300">Fuel Consumption</span>
                                    <span class="text-xs text-green-400">-22% reduction</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="text-center">
                                        <div id="baseFuelConsumption" class="text-red-400 font-bold text-lg">41.0 MT</div>
                                        <div class="text-xs text-red-300">Base calculation</div>
                                    </div>
                                    <div class="text-center">
                                        <div id="optimizedFuelConsumption" class="text-green-400 font-bold text-lg">32.0 MT</div>
                                        <div class="text-xs text-green-300">Actual calculation</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cost Savings -->
                            <div class="p-4 bg-slate-800/40 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm font-medium text-ocean-300">Total Cost</span>
                                    <span class="text-xs text-green-400">$5,400 saved</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="text-center">
                                        <div id="baseFuelCost" class="text-red-400 font-bold text-lg">$24,590</div>
                                        <div class="text-xs text-red-300">Standard route</div>
                                    </div>
                                    <div class="text-center">
                                        <div id="optimizedFuelCost" class="text-green-400 font-bold text-lg">$19,190</div>
                                        <div class="text-xs text-green-300">Actual route</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <!--  More Details Section -->
                    <div class="bg-black/30 rounded-xl p-6 border border-ocean-700/30">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-chart-line mr-3 text-yellow-400"></i>
                            More Details :-
                        </h3>
                    </div>
                    <!-- Chart Placeholder -->
                    <div class="h-80 bg-slate-900/50 rounded-lg border border-slate-700/50 flex items-center justify-center">
                        
                    </div>
                </div>
                </div>
            </div>            
            <!-- Interactive Timeline -->
            <div class="bg-slate-900 border-2 border-yellow-400 shadow-md shadow-yellow-400/30 rounded-2xl p-8" data-aos="fade-up" data-aos-delay="200">
                <h3 class="text-2xl font-bold mb-6 flex items-center">
                    <i class="fas fa-timeline mr-3 text-yellow-400"></i>
                    Interactive Route Timeline
                </h3>           
                <!-- Timeline Controls -->
                <div class="flex flex-wrap gap-4 mb-16">
                    <button class="glass px-4 py-2 rounded-lg text-sm hover:bg-white/10 transition-all flex items-center">
                        <i class="fas fa-play mr-2"></i>Play Timeline
                    </button>
                    <button class="glass px-4 py-2 rounded-lg text-sm hover:bg-white/10 transition-all flex items-center">
                        <i class="fas fa-fast-forward mr-2"></i>2x Speed
                    </button>
                    <button class="glass px-4 py-2 rounded-lg text-sm hover:bg-white/10 transition-all flex items-center">
                        <i class="fas fa-history mr-2"></i>Reset
                    </button>
                    <div class="flex items-center space-x-2 glass px-4 py-2 rounded-lg">
                        <span class="text-sm">Current Time:</span>
                        <span id="timelineTime" class="text-cyan-400 font-mono">08:00 UTC</span>
                    </div>
                </div>            
                <!-- Enhanced Timeline Visualization -->
                <div class="space-y-6">
                    <!-- Timeline Progress Bar -->
                    <div class="relative">
                        <div class="h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div id="timelineProgress" class="h-full bg-gradient-to-r from-green-400 via-yellow-400 to-red-400 rounded-full transition-all duration-1000" style="width: 25%"></div>
                        </div>
                        <div class="absolute timeline-current-indicator transform -translate-x-1/2 transition-all duration-1000 flex flex-col items-center" style="left: 25%; bottom: 100%;">
                            <div class="glass px-3 py-1 rounded-lg text-xs mb-1 text-center" style="white-space: normal;">
                                <i class="fas fa-ship mr-1"></i>Current Position
                            </div>
                            <svg width="18" height="10" viewBox="0 0 18 10" fill="#38bdf8" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 5px;">
                                <polygon points="1,1 9,9 17,1" />
                            </svg>
                        </div>
                    </div>              
                    <!-- Route Waypoints -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="flex items-center space-x-4 p-4 glass rounded-xl">
                            <div class="w-4 h-4 bg-green-400 rounded-full animate-pulse"></div>
                            <div class="flex-1">
                                <div class="text-sm font-semibold">Mumbai Port</div>
                                <div class="text-xs text-ocean-300">Departure: 08:00 UTC</div>
                                <div class="text-xs text-green-400">✓ Completed</div>
                            </div>
                            <i class="fas fa-check-circle text-green-400"></i>
                        </div>                        
                        <div class="flex items-center space-x-4 p-4 glass rounded-xl border border-yellow-400/30">
                            <div class="w-4 h-4 bg-yellow-400 rounded-full animate-pulse"></div>
                            <div class="flex-1">
                                <div class="text-sm font-semibold">Goa Transit</div>
                                <div class="text-xs text-ocean-300">ETA: 18:30 UTC</div>
                                <div class="text-xs text-yellow-400">⏳ In Progress</div>
                            </div>
                            <i class="fas fa-clock text-yellow-400"></i>
                        </div>                        
                        <div class="flex items-center space-x-4 p-4 glass rounded-xl opacity-60">
                            <div class="w-4 h-4 bg-gray-400 rounded-full"></div>
                            <div class="flex-1">
                                <div class="text-sm font-semibold">Kochi Port</div>
                                <div class="text-xs text-ocean-300">ETA: 14:45 UTC+1</div>
                                <div class="text-xs text-gray-400">⏱ Pending</div>
                            </div>
                            <i class="fas fa-hourglass text-gray-400"></i>
                        </div>
                    </div>
                </div>
                        </div>
                        <div class="text-sm text-gray-400">●</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer -->
    <footer class="mt-16 text-center bg-slate-900 border-t-2 border-yellow-400 shadow-md shadow-yellow-400/30 p-8 w-full" data-aos="fade-up">
        <div class="flex items-center justify-center mb-4">
            <i class="fas fa-anchor text-2xl text-yellow-400 mr-3 animate-wave"></i>
            <span class="text-xl font-bold gradient-text">Weather Engine Maritime</span>
        </div>
        <p class="text-yellow-300 mb-4">
            Advanced Maritime Intelligence Platform • MariTHON Hackathon 2025
        </p>
        <div class="flex justify-center space-x-6 text-sm text-yellow-400">
            <div class="flex items-center">
                <i class="fas fa-code mr-2"></i>
                FastAPI + Python
            </div>
            <div class="flex items-center">
                <i class="fas fa-palette mr-2"></i>
                TailwindCSS + HTML5
            </div>
            <div class="flex items-center">
                <i class="fas fa-map-marked-alt mr-2"></i>
                Leaflet.js
            </div>
        </div>
    </footer>
    <script>
        // Global variables
        let map;
        let weatherChart;
        let performanceChart;
        let weatherTrendChart;
        let fuelChart;
        let activeMapLayers = [];
        let waypointWeatherData = []; // Store weather data for each waypoint
        const API_BASE = 'http://localhost:8000';
        
        // OpenWeather API Configuration
        const OPENWEATHER_API_KEY = '24302ec53814dd7ded88bc752141cc52';
        const OPENWEATHER_BASE_URL = 'https://api.openweathermap.org/data/2.5';
        
        // Wind speed thresholds for color coding (in m/s)
        const WIND_THRESHOLDS = {
            low: 5,    // Green zone: 0-5 m/s (calm to light breeze)
            medium: 10, // Yellow zone: 5-10 m/s (moderate breeze)
            high: 15   // Red zone: 10+ m/s (strong breeze and above)
        };
        
        // Weather overlay data storage
        let weatherOverlayData = [];
        let overlayVisible = false;
        let overlayLayers = [];
        let windOverlayVisible = false;
        let windOverlayLayers = [];
        let tempOverlayLayers = [];
        let precipOverlayLayers = [];
        let tempOverlayVisible = false;
        let precipOverlayVisible = false;
        let currentOverlayType = null;
        
        // Open-Meteo API Configuration (Free weather and marine data APIs)
        // Note: Open-Meteo APIs are free and do not require API keys        
        // Port coordinates database
        const PORTS = {
            gopalpur: { name: 'Gopalpur Port (INGOP)', coords: [30.213982, 32.557983], country: '🇮🇳', code: 'INGOP' },
            newharbour: { name: 'New Harbour (INNH)', coords: [40.7081, -73.9779], country: '🇺🇸', code: 'INNH' },
            rotterdam: { name: 'Rotterdam Port (NLRTM)', coords: [30.213982, 32.557983], country: '🇳🇱', code: 'NLRTM' },
            singapore: { name: 'Singapore Port (SGSIN)', coords: [1.1, 103.6], country: '🇸🇬', code: 'SGSIN' }
        };

        // Predefined routes with exact waypoints from Weather Document
        const PREDEFINED_ROUTES = {
            'gopalpur_newharbour': {
                name: 'Gopalpur → New Harbour',
                waypoints: [
                    [30.213982, 32.557983], [30.318359, 32.382202], [30.945814, 32.306671],
                    [31.298117, 32.387159], [31.7, 32.1], [32.316071, 30.408377],
                    [32.863395, 28.905525], [33.115811, 28.212434], [33.219565, 27.927542],
                    [33.328, 27.6298], [33.748752, 26.306431], [34.011915, 25.478721],
                    [34.187436, 24.926664], [34.8, 23.0], [35.126694, 21.407365],
                    [35.845726, 17.902084], [36.086854, 16.726588], [36.4, 15.2],
                    [36.907095, 13.263819], [37.209117, 12.110644], [37.212689, 12.097004],
                    [37.215493, 12.086301], [37.283186, 11.827836], [37.454891, 11.172235],
                    [37.5, 11.0], [37.489085, 10.372293], [37.4851, 10.1431],
                    [37.4, 7.5], [37.2, 3.1], [36.666667, -0.366667],
                    [36.473171, -1.62439], [36.377724, -2.244793], [36.324512, -2.590675],
                    [36.220888, -3.264225], [36.158352, -3.670714], [36.156455, -3.683043],
                    [36.0, -4.7], [35.97289, -5.269383], [35.968819, -5.354867],
                    [35.95, -5.75], [36.31906, -7.26966], [36.549727, -8.219465],
                    [36.8, -9.25], [36.83741, -9.36445], [37.324914, -10.855872],
                    [37.417342, -11.138637], [37.717697, -12.057515], [38.272734, -13.755544],
                    [38.5182, -14.5065], [40.0, -20.0], [41.125083, -25.565029],
                    [41.1999, -25.9351], [41.584862, -28.584901], [41.790603, -30.001074],
                    [42.072366, -31.940532], [42.0901, -32.0626], [42.340269, -34.863425],
                    [42.592324, -37.685353], [42.6501, -38.3322], [42.706999, -40.001623],
                    [42.796183, -42.618304], [42.8665, -44.6814], [42.807466, -47.493255],
                    [42.754804, -50.001652], [42.733, -51.0402], [42.618612, -52.53975],
                    [42.613022, -52.613022], [42.2526, -57.3379], [41.53046, -62.794754],
                    [41.4359, -63.5093], [41.222837, -64.632986], [40.435954, -68.782982],
                    [40.430133, -68.813685], [40.413733, -68.900173], [40.412386, -68.907278],
                    [40.311722, -69.43818], [40.3, -69.5], [40.419295, -71.289425],
                    [40.437172, -71.557579], [40.453237, -71.798554], [40.535177, -73.027658],
                    [40.6, -74.0], [40.6061, -74.0456], [40.6285, -74.0561],
                    [40.6676, -74.0488], [40.7081, -73.9779]
                ]
            },
            'rotterdam_singapore': {
                name: 'Rotterdam → Singapore',
                waypoints: [
                    [30.213982, 32.557983], [29.7, 32.6], [27.9, 33.75],
                    [27.0, 34.5], [23.6, 37.0], [20.75, 38.9],
                    [16.3, 41.2], [15.0, 42.0], [12.7, 43.3],
                    [12.40439, 43.746586], [12.0, 45.0], [13.0, 51.0],
                    [12.577758, 53.059021], [12.2395, 54.7085], [11.4317, 58.3951],
                    [11.083455, 59.894005], [10.866984, 60.825733], [10.5802, 62.0601],
                    [10.031585, 64.303249], [9.934828, 64.698862], [9.862937, 64.992809],
                    [9.6889, 65.7044], [8.881605, 68.858995], [8.7613, 69.3291],
                    [8.6701, 69.671733], [8.582747, 69.999915], [8.365148, 70.817426],
                    [8.356493, 70.84994], [7.8014, 72.9354], [6.966807, 75.966807],
                    [6.8131, 76.5251], [5.8, 80.1], [5.9, 81.9],
                    [6.1983, 85.9479], [6.4664, 90.0], [6.7, 94.0],
                    [7.0, 97.0], [3.2, 100.6], [2.0, 102.0], [1.1, 103.6]
                ]
            }
        };
        // Initialize AOS animations
        AOS.init({
            duration: 1000,
            once: true,
            offset: 100
        });
        // Live time display
        // Static metrics display - no random values
        function animateMetrics() {
            const time = Date.now();            
            // Wave height - deterministic based on time
            const waveHeight = (2.3 + Math.sin(time / 10000) * 0.6).toFixed(1);
            document.getElementById('waveHeight').textContent = waveHeight + 'm';
            document.getElementById('currentWaves').textContent = waveHeight + 'm';            
            // Wind speed - deterministic based on time
            const windSpeed = (13 + Math.cos(time / 8000) * 3).toFixed(1);
            document.getElementById('windSpeed').textContent = windSpeed + ' kts';
            document.getElementById('currentWind').textContent = windSpeed + ' kts';            
            // Fuel savings - deterministic based on time
            const fuelSavings = (15.5 + Math.sin(time / 12000) * 2.5).toFixed(1);
            document.getElementById('fuelSavings').textContent = fuelSavings + '%';            
            // Visibility - deterministic based on time
            const visibility = (17 + Math.cos(time / 15000) * 5).toFixed(1);
            document.getElementById('currentVisibility').textContent = visibility + ' km';            
            // Update main fuel savings metric (keeping the one in the metrics section)
            const mainFuelSavingsElement = document.querySelector('.metric-counter#fuelSavings');
            if (mainFuelSavingsElement) {
                mainFuelSavingsElement.textContent = fuelSavings + '%';
            }
        }
        setInterval(animateMetrics, 2000);
        animateMetrics();
        // Enhanced map initialization with multiple layers
        function initMap() {
            try {
                // Show loader initially
                const loader = document.getElementById('mapLoader');
                const fallback = document.getElementById('mapFallback');                
                if (loader) loader.style.display = 'flex';
                if (fallback) fallback.style.display = 'none';
                map = L.map('map', {
                    zoomControl: true,
                    scrollWheelZoom: true,
                    doubleClickZoom: true,
                    boxZoom: true,
                    keyboard: true,
                    dragging: true,
                    tap: true,
                    touchZoom: true,
                    preferCanvas: true
                }).setView([15.0, 74.0], 6);                
                // Multiple tile layer options with fallbacks
                const OPENWEATHER_API_KEY = "3662ed76c1566a5fef2ac5a9d71c820a";
                const tileLayers = {
                    satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: '© Esri',
                        maxZoom: 19,
                        errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgdmlld0JveD0iMCAwIDI1NiAyNTYiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiBmaWxsPSIjMGY0Yzc1Ii8+CjwvSXZnPgo='
                    }),
                    ocean: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '© OpenStreetMap © CartoDB',
                        subdomains: 'abcd',
                        maxZoom: 19,
                        errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgdmlld0JveD0iMCAwIDI1NiAyNTYiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiBmaWxsPSIjMGY0Yzc1Ii8+CjwvSXZnPgo='
                    }),
                    openstreet: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap',
                        maxZoom: 19,
                        errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgdmlld0JveD0iMCAwIDI1NiAyNTYiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyNTYiIGhlaWdodD0iMjU2IiBmaWxsPSIjMGY0Yzc1Ii8+CjwvSXZnPgo='
                    }),
                    precipitation: L.tileLayer('https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${OPENWEATHER_API_KEY}', {
                        attribution: '© OpenWeatherMap',
                        maxZoom: 19,
                        opacity: 0.6,
                        errorTileUrl: 'data:image/svg+xml;base64,...'
                    }),
                    wind: L.tileLayer('https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=${OPENWEATHER_API_KEY}', {
                        attribution: '© OpenWeatherMap',
                        maxZoom: 19,
                        opacity: 0.6,
                        errorTileUrl: 'data:image/svg+xml;base64,...'
                    })
                };
                // Try satellite first, fallback to ocean theme
                let currentLayer = tileLayers.satellite;
                currentLayer.addTo(map);                
                // Handle tile loading errors
                currentLayer.on('tileerror', function() {
                    console.warn('Satellite tiles failed, switching to ocean theme...');
                    map.removeLayer(currentLayer);
                    currentLayer = tileLayers.ocean;
                    currentLayer.addTo(map);                    
                    currentLayer.on('tileerror', function() {
                        console.warn('Ocean tiles failed, switching to OpenStreetMap...');
                        map.removeLayer(currentLayer);
                        currentLayer = tileLayers.openstreet;
                        currentLayer.addTo(map);                        
                        currentLayer.on('tileerror', function() {
                            console.error('All tile sources failed, showing fallback...');
                            showMapFallback();
                        });
                    });
                });
                // Map ready event
                map.whenReady(function() {
                    setTimeout(() => {
                        if (loader) loader.style.display = 'none';
                        updateRouteDisplay();
                        drawRoute();
                    }, 1000);
                });
                // Map event listeners
                map.on('zoomend', () => {
                    document.getElementById('mapZoom').textContent = map.getZoom();
                });                
                map.on('moveend', () => {
                    // Map position updated
                });
                // Load timeout fallback
                setTimeout(() => {
                    if (loader && loader.style.display !== 'none') {
                        console.warn('Map loading timeout, showing fallback');
                        showMapFallback();
                    }
                }, 5000);                
            } catch (error) {
                console.error('Map initialization failed:', error);
                showMapFallback();
            }
        }
        // Show fallback map visualization
        function showMapFallback() {
            const loader = document.getElementById('mapLoader');
            const fallback = document.getElementById('mapFallback');            
            if (loader) loader.style.display = 'none';
            if (fallback) {
                fallback.style.display = 'block';
                fallback.classList.remove('hidden');
            }            
            // Update map type indicator
            document.getElementById('mapType').textContent = 'Fallback';            
            // Animate fallback elements
            setTimeout(() => {
                const markers = fallback.querySelectorAll('.animate-pulse');
                markers.forEach((marker, index) => {
                    marker.style.animationDelay = `${index * 0.5}s`;
                });
            }, 500);
        }
        // Validate route selection
        function validateRouteSelection() {
            const sourcePort = document.getElementById('sourcePort').value;
            const destPort = document.getElementById('destinationPort').value;
            
            if (sourcePort === destPort) {
                // Show error message
                showRouteValidationError('Source and destination ports cannot be the same. Please select different ports.');
                return false;
            }
            
            // Clear any existing error messages
            clearRouteValidationError();
            return true;
        }

        // Show route validation error
        function showRouteValidationError(message) {
            // Remove any existing error message
            clearRouteValidationError();
            
            // Create error message element
            const errorDiv = document.createElement('div');
            errorDiv.id = 'routeValidationError';
            errorDiv.className = 'mt-4 p-4 bg-red-900/50 border border-red-400 rounded-xl text-red-300 flex items-center';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle mr-3 text-red-400"></i>
                <span>${message}</span>
            `;
            
            // Insert after the route configuration section
            const routeConfigSection = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.gap-6').parentElement;
            routeConfigSection.appendChild(errorDiv);
        }

        // Clear route validation error
        function clearRouteValidationError() {
            const errorDiv = document.getElementById('routeValidationError');
            if (errorDiv) {
                errorDiv.remove();
            }
        }

        // Update route display and calculations
        function updateRouteDisplay() {
            try {
                const sourcePort = document.getElementById('sourcePort').value;
                const destPort = document.getElementById('destinationPort').value;
                
                // Add visual feedback for calculation updates
                const routeInfoSection = document.querySelector('.bg-gradient-to-r.from-ocean-800\\/50.to-cyan-800\\/50');
                if (routeInfoSection) {
                    routeInfoSection.style.transition = 'all 0.3s ease';
                    routeInfoSection.style.transform = 'scale(1.02)';
                    routeInfoSection.style.boxShadow = '0 0 20px rgba(14, 165, 233, 0.3)';
                    setTimeout(() => {
                        routeInfoSection.style.transform = 'scale(1)';
                        routeInfoSection.style.boxShadow = '';
                    }, 300);
                }            
                
                // Validate route selection first
                if (!validateRouteSelection()) {
                    clearRouteDisplay();
                    return;
                }
                
                const source = PORTS[sourcePort];
                const destination = PORTS[destPort];            
                if (source && destination) {
                    // Update route name
                    document.getElementById('currentRoute').textContent = 
                        `${source.name.split('(')[0].trim()} → ${destination.name.split('(')[0].trim()}`;
                    
                    // Calculate and validate all parameters
                    const distance = calculateRouteDistance(sourcePort, destPort);
                    const currentSpeed = parseInt(document.getElementById('speedLimit').value);
                    const fuelPrice = parseFloat(document.getElementById('fuelPrice').value);
                    const fuelConsumptionL100nm = parseFloat(document.getElementById('fuelConsumption').value);
                    
                    // Validate inputs
                    if (isNaN(distance) || distance <= 0) {
                        throw new Error('Invalid distance calculation');
                    }
                    if (isNaN(currentSpeed) || currentSpeed <= 0) {
                        throw new Error('Invalid speed setting');
                    }
                    if (isNaN(fuelPrice) || fuelPrice <= 0) {
                        throw new Error('Invalid fuel price');
                    }
                    if (isNaN(fuelConsumptionL100nm) || fuelConsumptionL100nm <= 0) {
                        throw new Error('Invalid fuel consumption');
                    }
                    
                    // Update distance display
                    document.getElementById('routeDistance').textContent = distance.toFixed(0) + ' nm';
                    
                    // Calculate and update duration
                    const totalHours = distance / currentSpeed;
                    const days = Math.floor(totalHours / 24);
                    const hours = Math.floor(totalHours % 24);
                    const minutes = Math.floor((totalHours - Math.floor(totalHours)) * 60);
                    
                    let durationText = '';
                    if (days > 0) durationText += `${days}d `;
                    if (hours > 0 || days > 0) durationText += `${hours}h `;
                    durationText += `${minutes}m`;
                    
                    document.getElementById('routeDuration').textContent = durationText;
                    
                    // Calculate and update fuel cost with speed factor
                    // Fuel consumption increases with speed (cubic relationship for ship resistance)
                    const baseSpeed = 18; // Base speed for the consumption rate (matches default slider value)
                    const speedFactor = Math.pow(currentSpeed / baseSpeed, 2.5); // Speed factor for fuel consumption
                    const adjustedConsumption = fuelConsumptionL100nm * speedFactor;
                    const totalFuelLiters = (adjustedConsumption * distance) / 100;
                    // Convert liters directly to MT (assuming fuel density is already factored into L/100nm rate)
                    const totalFuelMT = totalFuelLiters / 1000; // 1000L = 1MT for marine fuel pricing
                    const fuelCost = totalFuelMT * fuelPrice;
                    
                    document.getElementById('fuelCost').textContent = '$' + fuelCost.toFixed(0) + 
                        ` (${totalFuelMT.toFixed(1)}MT)`;
                }
            } catch (error) {
                console.error('Route calculation error:', error);
                clearRouteDisplay();
            }
        }
        
        // Update Advanced Analytics Dashboard with route configuration data
        function updateAnalyticsDashboard() {
            try {
                // Get current route configuration data automatically
                const sourcePort = document.getElementById('sourcePort').value;
                const destPort = document.getElementById('destinationPort').value;
                
                // Validate route selection
                if (!validateRouteSelection()) {
                    return;
                }
                
                // Calculate base route data from current configuration
                const distance = calculateRouteDistance(sourcePort, destPort);
                const currentSpeed = parseInt(document.getElementById('speedLimit').value);
                const fuelPrice = parseFloat(document.getElementById('fuelPrice').value);
                const fuelConsumptionL100nm = parseFloat(document.getElementById('fuelConsumption').value);
                
                // Calculate base duration
                const totalHours = distance / currentSpeed;
                const days = Math.floor(totalHours / 24);
                const hours = Math.floor(totalHours % 24);
                const minutes = Math.floor((totalHours - Math.floor(totalHours)) * 60);
                
                let baseDuration = '';
                if (days > 0) baseDuration += `${days}d `;
                if (hours > 0 || days > 0) baseDuration += `${hours}h `;
                baseDuration += `${minutes}m`;
                
                // Calculate base fuel consumption and cost
                const baseSpeed = 18;
                const speedFactor = Math.pow(currentSpeed / baseSpeed, 2.5);
                const adjustedConsumption = fuelConsumptionL100nm * speedFactor;
                const totalFuelLiters = (adjustedConsumption * distance) / 100;
                const baseFuelMT = totalFuelLiters / 1000;
                const baseFuelCost = baseFuelMT * fuelPrice;
                
                // Update base route values in analytics dashboard
                const baseRouteDurationEl = document.getElementById('baseRouteDuration');
                const baseFuelConsumptionEl = document.getElementById('baseFuelConsumption');
                const baseFuelCostEl = document.getElementById('baseFuelCost');
                
                if (baseRouteDurationEl) {
                    baseRouteDurationEl.textContent = baseDuration;
                }
                
                if (baseFuelConsumptionEl) {
                    baseFuelConsumptionEl.textContent = baseFuelMT.toFixed(1) + ' MT';
                }
                
                if (baseFuelCostEl) {
                    baseFuelCostEl.textContent = '$' + baseFuelCost.toFixed(0);
                }
                
                // Calculate optimized values using real environmental data if available
                const optimizedDurationEl = document.getElementById('optimizedRouteDuration');
                const optimizedFuelConsumptionEl = document.getElementById('optimizedFuelConsumption');
                const optimizedFuelCostEl = document.getElementById('optimizedFuelCost');
                
                // Try to use real environmental calculations
                if (waypointWeatherData && waypointWeatherData.length > 0) {
                    const sourcePort = document.getElementById('sourcePort').value;
                    const destPort = document.getElementById('destinationPort').value;
                    const distance = calculateRouteDistance(sourcePort, destPort);
                    const currentSpeed = parseInt(document.getElementById('speedLimit').value);
                    const fuelPrice = parseFloat(document.getElementById('fuelPrice').value);
                    const fuelConsumptionL100nm = parseFloat(document.getElementById('fuelConsumption').value);
                    
                    const optimizedMetrics = calculateOptimizedRouteMetrics(
                        waypointWeatherData, 
                        distance, 
                        currentSpeed, 
                        fuelPrice, 
                        fuelConsumptionL100nm
                    );
                    
                    if (optimizedMetrics) {
                        if (optimizedDurationEl) {
                            optimizedDurationEl.textContent = optimizedMetrics.optimizedDuration;
                        }
                        
                        if (optimizedFuelConsumptionEl) {
                            optimizedFuelConsumptionEl.textContent = optimizedMetrics.optimizedFuelMT.toFixed(1) + ' MT';
                        }
                        
                        if (optimizedFuelCostEl) {
                            optimizedFuelCostEl.textContent = '$' + optimizedMetrics.optimizedCost.toFixed(0);
                        }
                        
                        // Update environmental score
                        const envScoreEl = document.querySelector('.text-green-400.font-bold.text-xl');
                        if (envScoreEl) {
                            envScoreEl.textContent = `${optimizedMetrics.environmentalScore}/100`;
                        }
                        
                        // Update environmental factors display
                        updateEnvironmentalFactorsDisplay(waypointWeatherData);
                        
                        // Update savings display
                        const savings = baseFuelCost - optimizedMetrics.optimizedCost;
                        let savingsText;
                        if (savings > 0) {
                            savingsText = `$${savings.toFixed(0)} saved`;
                        } else if (savings < 0) {
                            savingsText = `$${Math.abs(savings).toFixed(0)} additional cost`;
                        } else {
                            savingsText = `$0 no change`;
                        }
                        
                        const savingsElements = document.querySelectorAll('.text-green-400');
                        savingsElements.forEach(el => {
                            if (el.textContent.includes('saved') || el.textContent.includes('additional cost') || el.textContent.includes('no change')) {
                                el.textContent = savingsText;
                                // Update color based on result
                                if (savings < 0) {
                                    el.className = el.className.replace('text-green-400', 'text-red-400');
                                } else if (savings > 0) {
                                    el.className = el.className.replace('text-red-400', 'text-green-400');
                                } else {
                                    el.className = el.className.replace('text-red-400', 'text-yellow-400').replace('text-green-400', 'text-yellow-400');
                                }
                            }
                        });
                        
                        // Update improvement percentages
                        const baseTotalHours = parseFloat(baseDuration.replace(/[dhm]/g, ' ').split(' ').reduce((total, part, index) => {
                            const num = parseFloat(part) || 0;
                            if (baseDuration.includes('d') && index === 0) return total + num * 24;
                            if (baseDuration.includes('h') && (index === 1 || !baseDuration.includes('d'))) return total + num;
                            return total;
                        }, 0));
                        
                        const timeChangePercent = ((baseTotalHours - optimizedMetrics.optimizedDurationHours) / baseTotalHours * 100);
                        const fuelChangePercent = ((baseFuelCost - optimizedMetrics.optimizedCost) / baseFuelCost * 100);
                        
                        // Format time change display
                        let timeDisplayText;
                        if (timeChangePercent > 0) {
                            timeDisplayText = `${timeChangePercent.toFixed(0)}% improvement`;
                        } else if (timeChangePercent < 0) {
                            timeDisplayText = `${Math.abs(timeChangePercent).toFixed(0)}% setback`;
                        } else {
                            timeDisplayText = `0% change`;
                        }
                        
                        // Format fuel change display
                        let fuelDisplayText;
                        if (fuelChangePercent > 0) {
                            fuelDisplayText = `${fuelChangePercent.toFixed(0)}% reduction`;
                        } else if (fuelChangePercent < 0) {
                            fuelDisplayText = `${Math.abs(fuelChangePercent).toFixed(0)}% increase`;
                        } else {
                            fuelDisplayText = `0% change`;
                        }
                        
                        // Update percentage displays
                        const percentageElements = document.querySelectorAll('.text-green-400');
                        percentageElements.forEach(el => {
                            if (el.textContent.includes('improvement') || el.textContent.includes('setback')) {
                                el.textContent = timeDisplayText;
                                // Update color based on result
                                if (timeChangePercent < 0) {
                                    el.className = el.className.replace('text-green-400', 'text-red-400');
                                } else {
                                    el.className = el.className.replace('text-red-400', 'text-green-400');
                                }
                            } else if (el.textContent.includes('reduction') || el.textContent.includes('increase')) {
                                el.textContent = fuelDisplayText;
                                // Update color based on result
                                if (fuelChangePercent < 0) {
                                    el.className = el.className.replace('text-green-400', 'text-red-400');
                                } else {
                                    el.className = el.className.replace('text-red-400', 'text-green-400');
                                }
                            }
                        });
                        
                        return; // Exit early if real calculations succeeded
                    }
                }
                
                // Fallback to simulated improvements if no weather data available
                const timeImprovement = 0.17; // 17% improvement
                const fuelImprovement = 0.22; // 22% reduction
                
                // Calculate optimized duration
                const baseTotalHours = parseFloat(baseDuration.replace(/[dhm]/g, ' ').split(' ').reduce((total, part, index) => {
                    const num = parseFloat(part) || 0;
                    if (baseDuration.includes('d') && index === 0) return total + num * 24;
                    if (baseDuration.includes('h') && (index === 1 || !baseDuration.includes('d'))) return total + num;
                    return total;
                }, 0));
                
                const optimizedTotalHours = baseTotalHours * (1 - timeImprovement);
                const optimizedDays = Math.floor(optimizedTotalHours / 24);
                const optimizedHours = Math.floor(optimizedTotalHours % 24);
                const optimizedMinutes = Math.floor((optimizedTotalHours - Math.floor(optimizedTotalHours)) * 60);
                
                let optimizedDurationText = '';
                if (optimizedDays > 0) optimizedDurationText += `${optimizedDays}d `;
                if (optimizedHours > 0 || optimizedDays > 0) optimizedDurationText += `${optimizedHours}h `;
                optimizedDurationText += `${optimizedMinutes}m`;
                
                if (optimizedDurationEl) {
                    optimizedDurationEl.textContent = optimizedDurationText;
                }
                
                // Calculate optimized fuel consumption and cost
                const optimizedFuelMT = baseFuelMT * (1 - fuelImprovement);
                const optimizedFuelCost = baseFuelCost * (1 - fuelImprovement);
                
                if (optimizedFuelConsumptionEl) {
                    optimizedFuelConsumptionEl.textContent = optimizedFuelMT.toFixed(1) + ' MT';
                }
                
                if (optimizedFuelCostEl) {
                    optimizedFuelCostEl.textContent = '$' + optimizedFuelCost.toFixed(0);
                }
                
                // Update savings display
                const savings = baseFuelCost - optimizedFuelCost;
                const savingsElements = document.querySelectorAll('.text-green-400');
                savingsElements.forEach(el => {
                    if (el.textContent.includes('saved')) {
                        el.textContent = `$${savings.toFixed(0)} saved`;
                    }
                });
                
            } catch (error) {
                console.error('Error updating analytics dashboard:', error);
            }
        }
        
        // Update environmental factors display in Advanced Analytics Dashboard
        function updateEnvironmentalFactorsDisplay(waypointWeatherData) {
            if (!waypointWeatherData || waypointWeatherData.length === 0) {
                return;
            }
            
            try {
                // Calculate average environmental impacts across all waypoints
                let totalWindAssistance = 0;
                let totalWaveResistance = 0;
                let favorableConditions = 0;
                
                waypointWeatherData.forEach(waypoint => {
                    if (waypoint.windSpeed && waypoint.windDirection && waypoint.movementDirection) {
                        const windImpact = calculateWindImpact(waypoint.windSpeed, waypoint.windDirection, waypoint.movementDirection);
                        // Convert speed factor to assistance percentage (1.0 = 0%, >1.0 = positive, <1.0 = negative)
                        const windAssistancePercent = Math.max(0, Math.min(100, (windImpact.speedFactor - 0.8) * 250));
                        totalWindAssistance += windAssistancePercent;
                    }
                    
                    if (waypoint.waveHeight && waypoint.swellHeight && waypoint.wavePeriod) {
                        const waveImpact = calculateWaveResistance(waypoint.waveHeight, waypoint.swellHeight, waypoint.wavePeriod);
                        // Convert wave resistance to percentage (1.0 = 50%, <1.0 = less resistance, >1.0 = more resistance)
                        const waveResistancePercent = Math.max(0, Math.min(100, (2.0 - waveImpact.speedFactor) * 50));
                        totalWaveResistance += waveResistancePercent;
                    }
                    
                    // Count favorable conditions (low waves + beneficial wind)
                    if (waypoint.waveHeight < 2.0 && waypoint.swellHeight < 1.5) {
                        favorableConditions++;
                    }
                });
                
                // Calculate averages
                const avgWindAssistance = Math.round(totalWindAssistance / waypointWeatherData.length);
                const avgWaveResistance = Math.round(totalWaveResistance / waypointWeatherData.length);
                const favorableConditionsPercent = Math.round((favorableConditions / waypointWeatherData.length) * 100);
                
                // Update wind assistance progress bar
                const windProgressBar = document.querySelector('.bg-green-500[style*="width: 72%"]');
                const windPercentageElements = document.querySelectorAll('.text-green-400.font-bold');
                const windPercentageText = Array.from(windPercentageElements).find(el => el.textContent.includes('%'));
                if (windProgressBar) {
                    windProgressBar.style.width = `${avgWindAssistance}%`;
                }
                if (windPercentageText) {
                    windPercentageText.textContent = `${avgWindAssistance}%`;
                }
                
                // Update wave conditions progress bar
                const waveProgressBar = document.querySelector('.bg-yellow-500[style*="width: 45%"]');
                const wavePercentageElements = document.querySelectorAll('.text-yellow-400.font-bold');
                const wavePercentageText = Array.from(wavePercentageElements).find(el => el.textContent.includes('%'));
                if (waveProgressBar) {
                    waveProgressBar.style.width = `${100 - avgWaveResistance}%`;
                }
                if (wavePercentageText) {
                    wavePercentageText.textContent = `${100 - avgWaveResistance}%`;
                }
                
                // Update ocean currents progress bar (use favorable conditions as proxy)
                const currentProgressBar = document.querySelector('.bg-blue-500[style*="width: 68%"]');
                const currentPercentageElements = document.querySelectorAll('.text-blue-400.font-bold');
                const currentPercentageText = Array.from(currentPercentageElements).find(el => el.textContent.includes('%'));
                if (currentProgressBar) {
                    currentProgressBar.style.width = `${favorableConditionsPercent}%`;
                }
                if (currentPercentageText) {
                    currentPercentageText.textContent = `${favorableConditionsPercent}%`;
                }
                
            } catch (error) {
                console.error('Error updating environmental factors display:', error);
            }
        }
        
        // Calculate optimized route metrics based on environmental conditions
        function calculateOptimizedRouteMetrics(waypointWeatherData, baseDistance, baseSpeed, baseFuelPrice, baseFuelConsumptionL100nm) {
            try {
                if (!waypointWeatherData || waypointWeatherData.length === 0) {
                    return null;
                }
                
                let totalOptimizedTime = 0;
                let totalOptimizedFuelConsumption = 0;
                const segmentDistance = baseDistance / waypointWeatherData.length;
                
                // Process each waypoint's environmental conditions
                for (let i = 0; i < waypointWeatherData.length; i++) {
                    const waypoint = waypointWeatherData[i];
                    
                    // Calculate environmental impact factors
                    const environmentalFactors = calculateEnvironmentalImpact(
                        waypoint.windSpeed,
                        waypoint.windDirection,
                        waypoint.movementDirection,
                        waypoint.waveHeight,
                        waypoint.swellHeight,
                        waypoint.wavePeriod
                    );
                    
                    // Apply environmental factors to speed and fuel consumption
                    const optimizedSpeed = baseSpeed * environmentalFactors.speedMultiplier;
                    const optimizedFuelRate = baseFuelConsumptionL100nm * environmentalFactors.fuelMultiplier;
                    
                    // Calculate segment time and fuel consumption
                    const segmentTime = segmentDistance / optimizedSpeed;
                    const segmentFuelConsumption = (optimizedFuelRate * segmentDistance) / 100;
                    
                    totalOptimizedTime += segmentTime;
                    totalOptimizedFuelConsumption += segmentFuelConsumption;
                }
                
                // Convert total fuel consumption to metric tons and calculate cost
                const totalOptimizedFuelMT = totalOptimizedFuelConsumption / 1000;
                const totalOptimizedCost = totalOptimizedFuelMT * baseFuelPrice;
                
                // Format optimized duration
                const optimizedDays = Math.floor(totalOptimizedTime / 24);
                const optimizedHours = Math.floor(totalOptimizedTime % 24);
                const optimizedMinutes = Math.floor((totalOptimizedTime - Math.floor(totalOptimizedTime)) * 60);
                
                let optimizedDurationText = '';
                if (optimizedDays > 0) optimizedDurationText += `${optimizedDays}d `;
                if (optimizedHours > 0 || optimizedDays > 0) optimizedDurationText += `${optimizedHours}h `;
                optimizedDurationText += `${optimizedMinutes}m`;
                
                return {
                    optimizedDuration: optimizedDurationText,
                    optimizedDurationHours: totalOptimizedTime,
                    optimizedFuelMT: totalOptimizedFuelMT,
                    optimizedCost: totalOptimizedCost,
                    environmentalScore: calculateOverallEnvironmentalScore(waypointWeatherData)
                };
                
            } catch (error) {
                console.error('Error calculating optimized route metrics:', error);
                return null;
            }
        }
        
        // Calculate environmental impact factors for a waypoint
        function calculateEnvironmentalImpact(windSpeed, windDirection, shipDirection, waveHeight, swellHeight, wavePeriod) {
            let speedMultiplier = 1.0;
            let fuelMultiplier = 1.0;
            
            // Wind impact calculation
            if (windSpeed && windDirection && shipDirection) {
                const windImpact = calculateWindImpact(windSpeed, windDirection, shipDirection);
                speedMultiplier *= windImpact.speedFactor;
                fuelMultiplier *= windImpact.fuelFactor;
            }
            
            // Wave and swell resistance calculation
            if (waveHeight && swellHeight && wavePeriod) {
                const waveImpact = calculateWaveResistance(waveHeight, swellHeight, wavePeriod);
                speedMultiplier *= waveImpact.speedFactor;
                fuelMultiplier *= waveImpact.fuelFactor;
            }
            
            // Ensure multipliers stay within reasonable bounds
            speedMultiplier = Math.max(0.6, Math.min(1.4, speedMultiplier));
            fuelMultiplier = Math.max(0.7, Math.min(1.5, fuelMultiplier));
            
            return {
                speedMultiplier: speedMultiplier,
                fuelMultiplier: fuelMultiplier
            };
        }
        
        // Calculate wind impact on ship performance
        function calculateWindImpact(windSpeed, windDirection, shipDirection) {
            if (!windSpeed || !windDirection || !shipDirection) {
                return { speedFactor: 1.0, fuelFactor: 1.0 };
            }
            
            // Calculate relative wind angle (difference between wind and ship direction)
            let relativeWindAngle = Math.abs(windDirection - shipDirection);
            if (relativeWindAngle > 180) {
                relativeWindAngle = 360 - relativeWindAngle;
            }
            
            // Convert wind speed from knots to impact factor
            const windSpeedKnots = windSpeed;
            const windStrength = Math.min(windSpeedKnots / 30, 1.0); // Normalize to 0-1 scale
            
            let speedFactor = 1.0;
            let fuelFactor = 1.0;
            
            // Tailwind (0-45 degrees): Beneficial
            if (relativeWindAngle <= 45) {
                speedFactor = 1.0 + (windStrength * 0.15); // Up to 15% speed increase
                fuelFactor = 1.0 - (windStrength * 0.12); // Up to 12% fuel reduction
            }
            // Crosswind (45-135 degrees): Neutral to slightly negative
            else if (relativeWindAngle <= 135) {
                speedFactor = 1.0 - (windStrength * 0.05); // Up to 5% speed decrease
                fuelFactor = 1.0 + (windStrength * 0.08); // Up to 8% fuel increase
            }
            // Headwind (135-180 degrees): Negative impact
            else {
                speedFactor = 1.0 - (windStrength * 0.20); // Up to 20% speed decrease
                fuelFactor = 1.0 + (windStrength * 0.25); // Up to 25% fuel increase
            }
            
            return { speedFactor: speedFactor, fuelFactor: fuelFactor };
        }
        
        // Calculate wave resistance impact on ship performance
        function calculateWaveResistance(waveHeight, swellHeight, wavePeriod) {
            if (!waveHeight || !swellHeight || !wavePeriod) {
                return { speedFactor: 1.0, fuelFactor: 1.0 };
            }
            
            // Combined wave effect (wave height + swell height)
            const totalWaveHeight = waveHeight + (swellHeight * 0.7); // Swell has less impact
            
            // Wave period impact (shorter periods = more resistance)
            const periodFactor = Math.max(0.5, Math.min(1.0, wavePeriod / 8)); // Normalize around 8s period
            
            // Calculate resistance based on wave height and period
            const waveResistance = (totalWaveHeight / 4) * (1 / periodFactor); // Normalize around 4m waves
            
            let speedFactor = 1.0;
            let fuelFactor = 1.0;
            
            // Apply wave resistance impact
            if (totalWaveHeight <= 1.5) {
                // Calm seas: Slight benefit
                speedFactor = 1.0 + 0.02;
                fuelFactor = 1.0 - 0.03;
            } else if (totalWaveHeight <= 3.0) {
                // Moderate seas: Minor impact
                speedFactor = 1.0 - (waveResistance * 0.08);
                fuelFactor = 1.0 + (waveResistance * 0.10);
            } else if (totalWaveHeight <= 5.0) {
                // Rough seas: Significant impact
                speedFactor = 1.0 - (waveResistance * 0.15);
                fuelFactor = 1.0 + (waveResistance * 0.20);
            } else {
                // Very rough seas: Major impact
                speedFactor = 1.0 - (waveResistance * 0.25);
                fuelFactor = 1.0 + (waveResistance * 0.35);
            }
            
            return { speedFactor: speedFactor, fuelFactor: fuelFactor };
        }
        
        // Calculate overall environmental optimization score
        function calculateOverallEnvironmentalScore(waypointWeatherData) {
            if (!waypointWeatherData || waypointWeatherData.length === 0) {
                return 50; // Neutral score
            }
            
            let totalScore = 0;
            
            for (const waypoint of waypointWeatherData) {
                let waypointScore = 50; // Base score
                
                // Wind score (0-40 points)
                if (waypoint.windSpeed && waypoint.windDirection && waypoint.movementDirection) {
                    const windImpact = calculateWindImpact(waypoint.windSpeed, waypoint.windDirection, waypoint.movementDirection);
                    waypointScore += (windImpact.speedFactor - 1) * 100; // Convert to score
                }
                
                // Wave score (0-30 points)
                if (waypoint.waveHeight && waypoint.swellHeight) {
                    const totalWaves = waypoint.waveHeight + waypoint.swellHeight;
                    if (totalWaves <= 2) waypointScore += 20;
                    else if (totalWaves <= 4) waypointScore += 10;
                    else waypointScore -= 10;
                }
                
                // Ensure score stays within 0-100 range
                waypointScore = Math.max(0, Math.min(100, waypointScore));
                totalScore += waypointScore;
            }
            
            return Math.round(totalScore / waypointWeatherData.length);
        }
        
        // Clear route display helper function
        function clearRouteDisplay() {
            document.getElementById('currentRoute').textContent = 'Invalid Route Selection';
            document.getElementById('routeDistance').textContent = '-- nm';
            document.getElementById('routeDuration').textContent = '-- --';
            document.getElementById('fuelCost').textContent = '$--';
        }
        // Calculate distance between two coordinates (Haversine formula)
        function calculateDistance(coord1, coord2) {
            const R = 3440; // Earth's radius in nautical miles
            const lat1 = coord1[0] * Math.PI / 180;
            const lat2 = coord2[0] * Math.PI / 180;
            const deltaLat = (coord2[0] - coord1[0]) * Math.PI / 180;
            const deltaLon = (coord2[1] - coord1[1]) * Math.PI / 180;
            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Calculate total route distance using waypoints
        function calculateRouteDistance(sourcePort, destPort) {
            const routeKey = `${sourcePort}_${destPort}`;
            
            // Check if predefined route exists
            if (PREDEFINED_ROUTES[routeKey]) {
                const waypoints = PREDEFINED_ROUTES[routeKey].waypoints;
                let totalDistance = 0;
                
                // Calculate distance between consecutive waypoints
                for (let i = 0; i < waypoints.length - 1; i++) {
                    totalDistance += calculateDistance(waypoints[i], waypoints[i + 1]);
                }
                
                return totalDistance;
            } else {
                // Fallback to straight-line distance for non-predefined routes
                const source = PORTS[sourcePort];
                const destination = PORTS[destPort];
                if (source && destination) {
                    return calculateDistance(source.coords, destination.coords);
                }
                return 0;
            }
        }
        // Enhanced route drawing
        function drawRoute() {
            // Show immediate fallback if map is not ready
            if (!map) {
                showMapFallback();
                return;
            }            
            try {
                // Clear existing route
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline || layer instanceof L.CircleMarker) {
                        map.removeLayer(layer);
                    }
                });
                
                // Validate route selection before drawing
                if (!validateRouteSelection()) {
                    console.warn('Invalid route selection: Source and destination cannot be the same');
                    return;
                }
                
                const sourcePort = document.getElementById('sourcePort').value;
                const destPort = document.getElementById('destinationPort').value;                
                const source = PORTS[sourcePort];
                const destination = PORTS[destPort];                
                if (!source || !destination) {
                    console.warn('Source or destination port not found');
                    return;
                }
                // Add enhanced markers
                const sourceIcon = L.divIcon({
                    html: `<div class="bg-green-500 w-6 h-6 rounded-full border-2 border-white flex items-center justify-center text-xs font-bold animate-pulse shadow-lg">S</div>`,
                    iconSize: [24, 24],
                    className: 'custom-marker'
                });                
                const destIcon = L.divIcon({
                    html: `<div class="bg-red-500 w-6 h-6 rounded-full border-2 border-white flex items-center justify-center text-xs font-bold shadow-lg">D</div>`,
                    iconSize: [24, 24],
                    className: 'custom-marker'
                });
                const sourceMarker = L.marker(source.coords, {icon: sourceIcon}).addTo(map)
                    .bindPopup(`
                        <div class="text-center p-2 min-w-48">
                            <h3 class="font-bold text-lg text-green-600">${source.country} ${source.name}</h3>
                            <p class="text-sm text-gray-600">Departure Port</p>
                            <p class="text-xs text-gray-500">${source.coords[0].toFixed(4)}°N, ${source.coords[1].toFixed(4)}°E</p>
                            <p class="text-xs font-mono bg-gray-100 px-2 py-1 rounded mt-1">${source.code}</p>
                            <div class="mt-2 text-xs text-green-600">🚢 Ready for departure</div>
                        </div>
                    `);
                const destMarker = L.marker(destination.coords, {icon: destIcon}).addTo(map)
                    .bindPopup(`
                        <div class="text-center p-2 min-w-48">
                            <h3 class="font-bold text-lg text-red-600">${destination.country} ${destination.name}</h3>
                            <p class="text-sm text-gray-600">Destination Port</p>
                            <p class="text-xs text-gray-500">${destination.coords[0].toFixed(4)}°N, ${destination.coords[1].toFixed(4)}°E</p>
                            <p class="text-xs font-mono bg-gray-100 px-2 py-1 rounded mt-1">${destination.code}</p>
                            <div class="mt-2 text-xs text-red-600">⚓ Arrival expected</div>
                        </div>
                    `);
                // Create route with waypoints
                const waypoints = generateWaypoints(source.coords, destination.coords);
                const fullRoute = [source.coords, ...waypoints, destination.coords];
                
                // Fetch weather data for waypoints
                if (waypoints.length > 0) {
                    fetchWaypointWeather(waypoints);
                }
                // Add route line with animation
                const routeLine = L.polyline(fullRoute, {
                    color: '#0ea5e9',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '10, 10',
                    className: 'route-line'
                }).addTo(map);
                // Add waypoint markers
                waypoints.forEach((point, index) => {
                    const waypointIcon = L.divIcon({
                        html: `<div class="bg-cyan-500 w-4 h-4 rounded-full border border-white shadow-md animate-ping"></div>`,
                        iconSize: [16, 16],
                        className: 'waypoint-marker'
                    });                    
                    L.marker(point, {icon: waypointIcon}).addTo(map)
                        .bindPopup(`
                            <div class="text-center">
                                <strong class="text-cyan-600">Waypoint ${index + 1}</strong>
                                <br><small class="text-gray-500">${point[0].toFixed(3)}°N, ${point[1].toFixed(3)}°E</small>
                                <br><small class="text-cyan-600">Navigation checkpoint</small>
                            </div>
                        `);
                });
                // Fit map to show full route
                map.fitBounds(fullRoute, { padding: [20, 20] });                
                // Update map status
                document.getElementById('mapType').textContent = 'Satellite';                
                // Route successfully drawn                
            } catch (error) {
                console.error('Error drawing route:', error);
                showMapFallback();
            }
        }
        // Generate waypoints between source and destination
        function generateWaypoints(start, end) {
            const sourcePort = document.getElementById('sourcePort').value;
            const destPort = document.getElementById('destinationPort').value;
            
            // Only use predefined routes
            const routeKey = `${sourcePort}_${destPort}`;
            if (PREDEFINED_ROUTES[routeKey]) {
                return PREDEFINED_ROUTES[routeKey].waypoints;
            }
            
            // Return empty array if no predefined route exists
            return [];
        }
        
        // Function to fetch weather data for waypoints
        async function fetchWaypointWeather(waypoints) {
            waypointWeatherData = []; // Clear previous data
            const waypointContainer = document.getElementById('waypointWeatherDataMain');
            
            // Get source and destination coordinates for better direction calculations
            const sourcePort = document.getElementById('sourcePort').value;
            const destPort = document.getElementById('destinationPort').value;
            const sourceCoords = PORTS[sourcePort]?.coords;
            const destCoords = PORTS[destPort]?.coords;
            
            // Show loading state
            waypointContainer.innerHTML = `
                <div class="text-center text-ocean-300 py-4">
                    <i class="fas fa-spinner fa-spin mr-2"></i>
                    Loading waypoint weather data...
                </div>
            `;
            
            try {
                for (let i = 0; i < waypoints.length; i++) {
                    const waypoint = waypoints[i];
                    
                    // Fetch real weather data from Open-Meteo Marine API
                    const weatherData = await fetchOpenMeteoMarineAPI(waypoint[0], waypoint[1]);
                    
                    // Check if API returned an error
                    if (weatherData.error) {
                        // Stop processing and show error in the display
                        waypointContainer.innerHTML = `
                            <div class="text-center text-red-400 py-6 px-4 bg-red-900/20 rounded-lg border border-red-600/30">
                                <i class="fas fa-exclamation-triangle text-2xl mb-3"></i>
                                <div class="font-semibold mb-2">Weather Data Unavailable</div>
                                <div class="text-sm text-red-300">${weatherData.errorMessage}</div>
                                <div class="text-xs text-red-400 mt-2">Check your internet connection and try again</div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Calculate movement direction at this waypoint
                    const movementDirection = calculateMovementDirection(waypoints, i, sourceCoords, destCoords);
                    const movementDirectionText = movementDirection ? getWindDirectionText(movementDirection) : 'N/A';
                    
                    waypointWeatherData.push({
                        index: i + 1,
                        coordinates: waypoint,
                        windSpeed: weatherData.windSpeed,
                        windDirection: weatherData.windDirection,
                        waveHeight: weatherData.waveHeight,
                        waveDirection: weatherData.waveDirection,
                        wavePeriod: weatherData.wavePeriod,
                        swellHeight: weatherData.swellHeight,
                        swellDirection: weatherData.swellDirection,
                        swellPeriod: weatherData.swellPeriod,
                        windWaveHeight: weatherData.windWaveHeight,
                        windWaveDirection: weatherData.windWaveDirection,
                        windWavePeriod: weatherData.windWavePeriod,
                        movementDirection: movementDirection,
                        movementDirectionText: movementDirectionText,
                        timestamp: new Date().toISOString()
                    });
                }
                
                // Update display
                updateWaypointWeatherDisplay();
                
                // Trigger analytics dashboard update with new environmental data
                const sourcePort = document.getElementById('sourcePort').value;
                const destPort = document.getElementById('destinationPort').value;
                if (sourcePort && destPort && waypointWeatherData.length > 0) {
                    // Get current route configuration values
                    const distance = calculateRouteDistance(sourcePort, destPort);
                    const currentSpeed = parseInt(document.getElementById('speedLimit').value);
                    const fuelPrice = parseFloat(document.getElementById('fuelPrice').value);
                    const fuelConsumptionL100nm = parseFloat(document.getElementById('fuelConsumption').value);
                    
                    // Calculate base metrics
                    const totalHours = distance / currentSpeed;
                    const totalFuelL = (distance / 100) * fuelConsumptionL100nm;
                    const totalFuelMT = totalFuelL / 1000; // Convert liters to metric tons (approximate)
                    const fuelCost = totalFuelMT * fuelPrice;
                    
                    // Format duration
                    const days = Math.floor(totalHours / 24);
                    const hours = Math.floor(totalHours % 24);
                    const minutes = Math.floor((totalHours - Math.floor(totalHours)) * 60);
                    
                    let durationText = '';
                    if (days > 0) durationText += `${days}d `;
                    if (hours > 0 || days > 0) durationText += `${hours}h `;
                    durationText += `${minutes}m`;
                    
                    // Update Advanced Analytics Dashboard with base route data
                    updateAnalyticsDashboard();
                }
                
            } catch (error) {
                console.error('Error fetching waypoint weather:', error);
                const container = document.getElementById('waypointWeatherDataMain');
                container.innerHTML = `
                    <div class="text-center text-red-400 py-8">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>Error loading weather data</p>
                        <p class="text-sm text-ocean-300 mt-2">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Fetch comprehensive marine weather data using Open-Meteo APIs
        // Combines Marine API (waves, swell) + Weather API (wind) for complete maritime data
        async function fetchOpenMeteoMarineAPI(lat, lon) {
            try {
                // Open-Meteo Marine API - provides wave height, swell, and marine conditions
                const marineUrl = `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&current=wave_height,wave_direction,wave_period,swell_wave_height,swell_wave_direction,swell_wave_period,wind_wave_height,wind_wave_direction,wind_wave_period&timezone=auto`;
                
                // Open-Meteo Weather API - provides atmospheric wind data
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=wind_speed_10m,wind_direction_10m&wind_speed_unit=ms&timezone=auto`;
                
                // Fetch both Open-Meteo marine and atmospheric data in parallel
                const [marineResponse, weatherResponse] = await Promise.all([
                    fetch(marineUrl, { method: 'GET', headers: { 'Accept': 'application/json' } }),
                    fetch(weatherUrl, { method: 'GET', headers: { 'Accept': 'application/json' } })
                ]);
                
                if (!marineResponse.ok || !weatherResponse.ok) {
                    throw new Error(`Open-Meteo API error: Marine ${marineResponse.status}, Weather ${weatherResponse.status}`);
                }
                
                const [marineData, weatherData] = await Promise.all([
                    marineResponse.json(),
                    weatherResponse.json()
                ]);
                
                // Console log the actual Open-Meteo API responses for debugging
                console.log('Open-Meteo Marine API Response for', lat, lon, ':', marineData);
                console.log('Open-Meteo Weather API Response for', lat, lon, ':', weatherData);
                
                // Extract wind data
                const windSpeed = weatherData.current?.wind_speed_10m || 0; // m/s
                const windDirection = weatherData.current?.wind_direction_10m || 0; // degrees
                const windSpeedKnots = windSpeed * 1.94384;
                
                // Extract marine data
                const waveHeight = marineData.current?.wave_height || 0; // meters
                const waveDirection = marineData.current?.wave_direction || 0; // degrees
                const wavePeriod = marineData.current?.wave_period || 0; // seconds
                
                const swellHeight = marineData.current?.swell_wave_height || 0; // meters
                const swellDirection = marineData.current?.swell_wave_direction || 0; // degrees
                const swellPeriod = marineData.current?.swell_wave_period || 0; // seconds
                
                const windWaveHeight = marineData.current?.wind_wave_height || 0; // meters
                const windWaveDirection = marineData.current?.wind_wave_direction || 0; // degrees
                const windWavePeriod = marineData.current?.wind_wave_period || 0; // seconds
                
                const processedData = {
                    windSpeed: Math.round(windSpeedKnots * 10) / 10,
                    windDirection: Math.round(windDirection),
                    waveHeight: Math.round(waveHeight * 10) / 10,
                    waveDirection: Math.round(waveDirection),
                    wavePeriod: Math.round(wavePeriod * 10) / 10,
                    swellHeight: Math.round(swellHeight * 10) / 10,
                    swellDirection: Math.round(swellDirection),
                    swellPeriod: Math.round(swellPeriod * 10) / 10,
                    windWaveHeight: Math.round(windWaveHeight * 10) / 10,
                    windWaveDirection: Math.round(windWaveDirection),
                    windWavePeriod: Math.round(windWavePeriod * 10) / 10
                };
                
                console.log('Processed weather data for', lat, lon, ':', processedData);
                return processedData;
                
            } catch (error) {
                console.error('Error fetching marine weather data:', error);
                
                // Return error flag instead of fallback data
                return {
                    error: true,
                    errorMessage: error.message || 'Failed to fetch weather data'
                };
            }
        }
        
        // Update waypoint weather display
        function updateWaypointWeatherDisplay() {
            const container = document.getElementById('waypointWeatherDataMain');
            
            if (waypointWeatherData.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-ocean-300 py-8">
                        <i class="fas fa-route text-4xl mb-4 opacity-50"></i>
                        <p>Generate a route to view waypoint weather data</p>
                        <p class="text-xs mt-2 opacity-75">Weather conditions will be displayed for each navigation point</p>
                    </div>
                `;
                return;
            }
            
            const weatherHTML = waypointWeatherData.map(data => {
                const windDirectionText = getWindDirectionText(data.windDirection);
                const waveDirectionText = getWindDirectionText(data.waveDirection);
                const swellDirectionText = getWindDirectionText(data.swellDirection);
                
                return `
                    <div class="py-3 px-3 bg-slate-800/30 rounded-lg border border-ocean-700/20 hover:bg-slate-700/30 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-cyan-400 font-mono text-xs bg-cyan-900/30 px-2 py-1 rounded">WP${data.index}</span>
                            <div class="text-xs text-ocean-300 text-right">
                                ${data.coordinates[0].toFixed(4)}°, ${data.coordinates[1].toFixed(4)}°
                            </div>
                        </div>
                        
                        <!-- Ship Movement Direction -->
                        <div class="mb-2 p-2 bg-purple-900/20 rounded border border-purple-600/30">
                            <div class="flex items-center justify-between text-xs">
                                <span class="text-purple-300 font-semibold flex items-center">
                                    <i class="fas fa-ship mr-1"></i>Ship Direction
                                </span>
                                <span class="text-purple-400 font-bold">
                                    ${data.movementDirectionText} (${data.movementDirection || 'N/A'}°)
                                </span>
                            </div>
                        </div>
                        
                        <!-- Wind Data -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div class="text-xs">
                                <div class="text-yellow-400 font-semibold">${data.windSpeed} kts</div>
                                <div class="text-ocean-300">${windDirectionText} (${data.windDirection}°)</div>
                            </div>
                            <div class="text-xs text-right">
                                <div class="text-cyan-400 font-semibold">${data.waveHeight}m waves</div>
                                <div class="text-ocean-300">${waveDirectionText} ${data.wavePeriod}s</div>
                            </div>
                        </div>
                        
                        <!-- Swell Data -->
                        <div class="grid grid-cols-2 gap-2 text-xs border-t border-ocean-700/20 pt-2">
                            <div>
                                <div class="text-blue-400">Swell: ${data.swellHeight}m</div>
                                <div class="text-ocean-400">${swellDirectionText} ${data.swellPeriod}s</div>
                            </div>
                            <div class="text-right">
                                <div class="text-green-400">Wind Wave: ${data.windWaveHeight}m</div>
                                <div class="text-ocean-400">${data.windWavePeriod}s period</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = weatherHTML;
        }
        
        // Convert wind direction degrees to compass direction
        function getWindDirectionText(degrees) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }

        // Calculate bearing (direction) between two coordinates in degrees
        function calculateBearing(lat1, lon1, lat2, lon2) {
            const toRadians = (degrees) => degrees * (Math.PI / 180);
            const toDegrees = (radians) => radians * (180 / Math.PI);
            
            const dLon = toRadians(lon2 - lon1);
            const lat1Rad = toRadians(lat1);
            const lat2Rad = toRadians(lat2);
            
            const y = Math.sin(dLon) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLon);
            
            let bearing = toDegrees(Math.atan2(y, x));
            
            // Normalize to 0-360 degrees
            bearing = (bearing + 360) % 360;
            
            return Math.round(bearing);
        }

        // Calculate movement direction at a waypoint based on previous and next coordinates
        function calculateMovementDirection(waypoints, currentIndex, sourceCoords = null, destCoords = null) {
            const totalWaypoints = waypoints.length;
            
            if (totalWaypoints === 0) return null;
            
            let fromCoords, toCoords;
            
            if (currentIndex === 0) {
                // First waypoint: direction from source port to this waypoint
                fromCoords = sourceCoords || waypoints[0];
                toCoords = waypoints[0];
                
                // If we have a next waypoint, use direction to next waypoint instead
                if (totalWaypoints > 1) {
                    fromCoords = waypoints[0];
                    toCoords = waypoints[1];
                }
            } else if (currentIndex === totalWaypoints - 1) {
                // Last waypoint: direction from previous waypoint to destination
                fromCoords = waypoints[currentIndex - 1];
                toCoords = destCoords || waypoints[currentIndex];
                
                // If no destination provided, use direction from previous waypoint
                if (!destCoords) {
                    fromCoords = waypoints[currentIndex - 1];
                    toCoords = waypoints[currentIndex];
                }
            } else {
                // Middle waypoint: average direction from previous to next waypoint
                const prevCoords = waypoints[currentIndex - 1];
                const nextCoords = waypoints[currentIndex + 1];
                
                // Calculate bearing from previous to current, and current to next
                const bearing1 = calculateBearing(prevCoords[0], prevCoords[1], waypoints[currentIndex][0], waypoints[currentIndex][1]);
                const bearing2 = calculateBearing(waypoints[currentIndex][0], waypoints[currentIndex][1], nextCoords[0], nextCoords[1]);
                
                // Average the two bearings (handling circular nature of degrees)
                let avgBearing = (bearing1 + bearing2) / 2;
                
                // Handle cases where bearings cross 0/360 boundary
                if (Math.abs(bearing1 - bearing2) > 180) {
                    avgBearing = (avgBearing + 180) % 360;
                }
                
                return Math.round(avgBearing);
            }
            
            if (fromCoords && toCoords) {
                return calculateBearing(fromCoords[0], fromCoords[1], toCoords[0], toCoords[1]);
            }
            
            return 0; // Default bearing if calculation fails
        }
        // Initialize all advanced charts
        function initPerformanceChart() {
            const canvas = document.getElementById('performanceChart');
            if (!canvas) {
                console.log('Performance chart canvas not found, skipping initialization');
                return;
            }
            const ctx = canvas.getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Fuel Efficiency', 'Speed Optimization', 'Route Safety', 'Weather Adaptation', 'Cost Effectiveness', 'Time Management'],
                    datasets: [{
                        label: 'Current Performance',
                        data: [85, 92, 78, 88, 90, 84],
                        backgroundColor: 'rgba(34, 197, 94, 0.2)',
                        borderColor: '#22c55e',
                        borderWidth: 2,
                        pointBackgroundColor: '#22c55e',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.2)' },
                            pointLabels: { color: '#94a3b8', font: { size: 11 } }
                        }
                    }
                }
            });
        }
        function initWeatherTrendChart() {
            const canvas = document.getElementById('weatherTrendChart');
            if (!canvas) {
                console.log('Weather trend chart canvas not found, skipping initialization');
                return;
            }
            const ctx = canvas.getContext('2d');
            weatherTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
                    datasets: [
                        {
                            label: 'Temperature (°C)',
                            data: [24, 26, 28, 27, 25, 23, 24],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Humidity (%)',
                            data: [65, 70, 75, 73, 68, 62, 66],
                            borderColor: '#06b6d4',
                            backgroundColor: 'rgba(6, 182, 212, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { color: '#94a3b8', font: { size: 10 } }
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: { 
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }
        function initFuelChart() {
            const canvas = document.getElementById('fuelChart');
            if (!canvas) {
                console.log('Fuel chart canvas not found, skipping initialization');
                return;
            }
            const ctx = canvas.getContext('2d');
            fuelChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Optimized Route', 'Engine Efficiency', 'Weather Routing', 'Speed Control', 'Waste'],
                    datasets: [{
                        data: [35, 25, 20, 15, 5],
                        backgroundColor: [
                            '#22c55e',
                            '#3b82f6',
                            '#8b5cf6',
                            '#f59e0b',
                            '#ef4444'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom',
                            labels: { color: '#94a3b8', font: { size: 10 } }
                        }
                    }
                }
            });
        }
        // Enhanced API functions
        async function checkAPI() {
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();                
                document.getElementById('apiStatus').innerHTML = `
                    <i class="fas fa-check text-green-400 mr-2"></i>
                    <span class="text-green-400">Online</span>
                `;
            } catch (error) {
                document.getElementById('apiStatus').innerHTML = `
                    <i class="fas fa-times text-red-400 mr-2"></i>
                    <span class="text-red-400">Offline</span>
                `;
            }
        }
        // Enhanced forecast loading with timeline support
        async function loadForecast() {
            const button = document.getElementById('loadForecast');
            const resultDiv = document.getElementById('forecastData');
            const timeline = document.getElementById('weatherTimeline').value;            
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            button.disabled = true;
            try {
                const response = await fetch(`${API_BASE}/route_forecast`);
                const data = await response.json();                
                if (data && Array.isArray(data) && data.length > 0) {
                    const firstSegment = data[0];
                    const forecastTimes = firstSegment.forecast?.times || [];                    
                    // Filter based on timeline
                    const timelineHours = parseInt(timeline.replace('h', ''));
                    const now = new Date();
                    const filteredForecast = forecastTimes.filter(point => {
                        const pointTime = new Date(point.t_iso);
                        const hoursDiff = (pointTime - now) / (1000 * 60 * 60);
                        return hoursDiff >= 0 && hoursDiff <= timelineHours;
                    });
                    const summary = filteredForecast.slice(0, 8).map(point => 
                        `<div class="flex justify-between items-center py-2 border-b border-ocean-700/30">
                            <span class="text-xs">${new Date(point.t_iso).toLocaleDateString()}</span>
                            <span class="text-ocean-300">${point.wind_deg}°</span>
                            <span class="text-sm font-semibold text-cyan-400">${point.wind_speed_ms.toFixed(1)} m/s</span>
                        </div>`
                    ).join('');                    
                    resultDiv.innerHTML = `
                        <div class="space-y-2 mb-3">
                            <div class="flex justify-between">
                                <span class="text-ocean-300">Forecast Period:</span>
                                <span class="text-cyan-400">${timeline}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-ocean-300">Data Points:</span>
                                <span class="text-yellow-400">${filteredForecast.length}</span>
                            </div>
                        </div>
                        ${summary}
                    `;
                    // Update weather chart with filtered data
                    const chartData = filteredForecast.slice(0, 5).map(point => 
                        point.waves?.Hs_m || 2.0
                    );
                    if (weatherChart && chartData.length > 0) {
                        weatherChart.data.datasets[0].data = chartData;
                        weatherChart.update();
                    }
                } else {
                    throw new Error('No forecast data');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="text-red-400 flex items-center mb-2">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Failed to load forecast. Using mock data.
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-ocean-300">Current Conditions:</span>
                            <span class="text-cyan-400">Fair weather</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-ocean-300">Wind Speed:</span>
                            <span class="text-yellow-400">12.8 kts</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-ocean-300">Wave Height:</span>
                            <span class="text-cyan-200">2.4m</span>
                        </div>
                    </div>
                `;
            } finally {
                button.innerHTML = '<i class="fas fa-download mr-2"></i>Load Forecast';
                button.disabled = false;
            }
        }
        // Enhanced optimization with parameters
        async function optimizeRoute() {
            // Validate route selection before optimization
            if (!validateRouteSelection()) {
                alert('Cannot optimize route: Source and destination ports cannot be the same. Please select different ports.');
                return;
            }
            
            const button = document.getElementById('optimizeRoute');
            const optimizeText = document.getElementById('optimizeText');
            const mode = document.getElementById('optimizationMode').value;
            const speedLimit = parseInt(document.getElementById('speedLimit').value);
            const fuelPrice = parseFloat(document.getElementById('fuelPrice').value);
            const fuelConsumptionL100nm = parseFloat(document.getElementById('fuelConsumption').value);            
            optimizeText.textContent = 'Optimizing...';
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i><span id="optimizeText">Optimizing...</span>';
            button.disabled = true;
            try {
                const sourcePort = document.getElementById('sourcePort').value;
                const destPort = document.getElementById('destinationPort').value;
                const source = PORTS[sourcePort];
                const destination = PORTS[destPort];
                // Create route segments based on selected ports
                const optimizeRequest = {
                    route: [
                        { segment_id: 1, lat: source.coords[0], lon: source.coords[1], dist_nm: 0 },
                        { segment_id: 2, lat: (source.coords[0] + destination.coords[0]) / 2, lon: (source.coords[1] + destination.coords[1]) / 2, dist_nm: 200 },
                        { segment_id: 3, lat: destination.coords[0], lon: destination.coords[1], dist_nm: 400 }
                    ],
                    vessel: {
                        name: `Express Vessel ${source.code} → ${destination.code}`,
                        base_speed_kn: speedLimit,
                        fuel_consumption_l_per_100nm: fuelConsumptionL100nm,
                        fuel_price_per_mt: fuelPrice
                    },
                    constraints: {
                        deadline_iso: null,
                        optimization_mode: mode,
                        max_speed_kn: speedLimit,
                        fuel_price: fuelPrice,
                        fuel_consumption: fuelConsumptionL100nm
                    }
                };
                const response = await fetch(`${API_BASE}/optimize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(optimizeRequest)
                });                
                const data = await response.json();                
                if (data.speed_profile) {
                    const savings = data.savings_pct || 15.3;
                    // Show success message
                    showAlert('success', 'Route Optimization Complete', `Fuel savings: ${savings.toFixed(1)}%`);
                } else {
                    throw new Error('No optimization data');
                }
            } catch (error) {
                // Show error message
                showAlert('error', 'Optimization Failed', 'Using mock results for demonstration');
            } finally {
                optimizeText.textContent = 'Optimize Speed Profile';
                button.innerHTML = '<i class="fas fa-rocket mr-2"></i><span id="optimizeText">Optimize Speed Profile</span>';
                button.disabled = false;
            }
        }
        // Alert Popup System
        let alertPopupPosition = 'top-right';
        let popupCounter = 0;
        function togglePopupPosition() {
            const container = document.getElementById('alertPopupContainer');
            const positionText = document.getElementById('positionText');            
            if (alertPopupPosition === 'top-right') {
                alertPopupPosition = 'bottom-right';
                container.className = 'alert-popup-container bottom-right';
                positionText.textContent = 'Bottom Right';
            } else {
                alertPopupPosition = 'top-right';
                container.className = 'alert-popup-container top-right';
                positionText.textContent = 'Top Right';
            }
        }
        // Alert Sound System
        function playAlertSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);                
                // Longer beep sound with pleasant tone
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                oscillator.type = 'sine';                
                // Increased duration from 0.2 to 0.4 seconds
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);
            } catch (error) {
                // Web Audio API not supported
            }
        }
        // Helper function for simple alert messages
        function showAlert(type, title, description) {
            const alertData = {
                type: type === 'success' ? 'navigation' : 'fuel',
                title: title,
                description: description,
                time: new Date().toLocaleTimeString('en-US', { 
                    hour12: false, 
                    timeZone: 'UTC',
                    hour: '2-digit', 
                    minute: '2-digit' 
                }) + ' UTC'
            };
            showAlertPopup(alertData);
        }
        function showAlertPopup(alertData) {
            const container = document.getElementById('alertPopupContainer');
            const popupId = `popup-${++popupCounter}`;            
            // Play alert sound
            playAlertSound();            
            const severityColors = {
                'weather': { bg: 'rgba(234, 179, 8, 0.2)', border: '#eab308', icon: 'fa-cloud-bolt' },
                'navigation': { bg: 'rgba(249, 115, 22, 0.2)', border: '#f97316', icon: 'fa-compass' },
                'security': { bg: 'rgba(239, 68, 68, 0.2)', border: '#ef4444', icon: 'fa-shield-alt' },
                'mechanical': { bg: 'rgba(168, 85, 247, 0.2)', border: '#a855f7', icon: 'fa-cog' },
                'traffic': { bg: 'rgba(59, 130, 246, 0.2)', border: '#3b82f6', icon: 'fa-ship' },
                'fuel': { bg: 'rgba(239, 68, 68, 0.2)', border: '#ef4444', icon: 'fa-gas-pump' }
            };
            const colorData = severityColors[alertData.type] || severityColors['weather'];
            const popup = document.createElement('div');
            popup.id = popupId;
            popup.className = 'alert-popup';
            popup.style.borderLeftColor = colorData.border;
            popup.style.background = colorData.bg;
            popup.innerHTML = `
                <div class="close-btn" onclick="closeAlertPopup('${popupId}')">
                    <i class="fas fa-times text-xs"></i>
                </div>
                <div class="flex items-start">
                    <i class="fas ${colorData.icon} mr-3 mt-1" style="color: ${colorData.border}"></i>
                    <div class="flex-1">
                        <div class="mb-2">
                            <span class="font-semibold text-xs" style="color: ${colorData.border}">${alertData.title}</span>
                        </div>
                        <p class="text-ocean-100 text-sm mb-2">${alertData.description}</p>
                        ${alertData.metric ? `
                            <div class="flex items-center justify-between text-xs text-ocean-300">
                                <div class="flex items-center">
                                    <i class="fas ${alertData.metricIcon} mr-1"></i>
                                    <span>${alertData.metric}</span>
                                </div>
                                <span>${alertData.time}</span>
                            </div>
                        ` : `
                            <div class="flex justify-end text-xs text-ocean-300">
                                <span>${alertData.time}</span>
                            </div>
                        `}
                    </div>
                </div>
            `;            
            if (alertPopupPosition === 'bottom-right') {
                container.insertBefore(popup, container.firstChild);
            } else {
                container.appendChild(popup);
            }            
            // Trigger animation
            setTimeout(() => popup.classList.add('show'), 10);
            
            // Auto-remove after 6 seconds
            setTimeout(() => closeAlertPopup(popupId), 6000);
        }
        function closeAlertPopup(popupId) {
            const popup = document.getElementById(popupId);
            if (popup) {
                popup.classList.add('hide');
                setTimeout(() => {
                    if (popup.parentNode) {
                        popup.parentNode.removeChild(popup);
                    }
                }, 300);
            }
        }
        function triggerAlertPopups(selectedCategories) {
            const alertsData = {
                'weather': {
                    type: 'weather',
                    title: 'WEATHER WARNING',
                    time: '14:30 UTC',
                    description: 'High winds (25-30 knots) expected in sector 7-9. Recommend reduced speed.',
                    metric: 'Wind Speed: 28 knots',
                    metricIcon: 'fa-wind'
                },
                'navigation': [
                    {
                        type: 'navigation',
                        title: 'NAVIGATION ALERT',
                        time: '12:45 UTC',
                        description: 'Dense fog reported in approach channels. Visibility reduced to 0.5 nautical miles.',
                        metric: 'Visibility: 0.5 nm',
                        metricIcon: 'fa-eye-slash'
                    },
                    {
                        type: 'traffic',
                        title: 'TRAFFIC ALERT',
                        time: '16:20 UTC',
                        description: 'Heavy traffic congestion at Port Mumbai. Expected delay: 2-3 hours.',
                        metric: 'Queue: 12 vessels',
                        metricIcon: 'fa-ship'
                    }
                ],
                'mechanical': [
                    {
                        type: 'mechanical',
                        title: 'MAINTENANCE',
                        time: '18:00 UTC',
                        description: 'Engine temperature slightly elevated. Schedule maintenance check at next port.',
                        metric: 'Temperature: 85°C',
                        metricIcon: 'fa-thermometer-half'
                    },
                    {
                        type: 'fuel',
                        title: 'FUEL WARNING',
                        time: '20:15 UTC',
                        description: 'Fuel consumption 15% higher than optimal. Consider route optimization.',
                        metric: 'Efficiency: 85%',
                        metricIcon: 'fa-gas-pump'
                    }
                ],
                'security': {
                    type: 'security',
                    title: 'SECURITY ALERT',
                    time: '22:30 UTC',
                    description: 'Piracy risk elevated in coordinates 18°N, 69°E. Maintain safe distance from coast.',
                    metric: 'Risk Level: High',
                    metricIcon: 'fa-shield-alt'
                }
            };
            let delay = 0;
            selectedCategories.forEach(category => {
                const categoryAlerts = alertsData[category];
                if (categoryAlerts) {
                    if (Array.isArray(categoryAlerts)) {
                        categoryAlerts.forEach(alert => {
                            setTimeout(() => showAlertPopup(alert), delay);
                            delay += 1500; // 1.5 second delay between alerts
                        });
                    } else {
                        setTimeout(() => showAlertPopup(categoryAlerts), delay);
                        delay += 1500;
                    }
                }
            });
        }
        // Enhanced alerts with different types
        async function loadAlerts() {
            const button = document.getElementById('loadAlerts');
            const resultDiv = document.getElementById('alertsData');
            const alertBadge = document.getElementById('alertBadge');            
            // Check if this function was called by clicking the scan button
            // (We'll track this with a flag)
            if (!window.scanButtonClicked) {
                return; // Don't show alerts unless scan button was clicked
            }            
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Scanning...';
            button.disabled = true;
            try {
                const response = await fetch(`${API_BASE}/alerts`);
                const data = await response.json();                
                if (data.alerts && data.alerts.length > 0) {
                    const alertsHtml = data.alerts.map(alert => {
                        const severityColors = {
                            'low': 'yellow',
                            'medium': 'orange', 
                            'high': 'red',
                            'critical': 'red'
                        };
                        const color = severityColors[alert.severity.toLowerCase()] || 'yellow';                        
                        return `
                        <div class="bg-${color}-900/30 border-l-4 border-${color}-400 p-3 mb-2 rounded">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-exclamation-triangle text-${color}-400 mr-2"></i>
                                    <span class="font-semibold">${alert.type}</span>
                                </div>
                                <span class="text-xs bg-${color}-500/20 px-2 py-1 rounded">${alert.severity.toUpperCase()}</span>
                            </div>
                            <div class="text-xs text-${color}-200 mt-1">${alert.description}</div>
                            <div class="text-xs text-${color}-300 mt-1">Area: ${alert.area || 'Route area'}</div>
                        </div>
                    `;}).join('');                    
                    resultDiv.innerHTML = alertsHtml;
                    document.getElementById('alertCount').textContent = data.alerts.length;
                    document.getElementById('warningCount').textContent = data.alerts.filter(a => a.severity === 'medium').length;
                    document.getElementById('criticalCount').textContent = data.alerts.filter(a => a.severity === 'high' || a.severity === 'critical').length;
                    alertBadge.textContent = `${data.alerts.length} Active Alert${data.alerts.length !== 1 ? 's' : ''}`;
                    alertBadge.className = 'text-xs px-2 py-1 bg-red-500/20 rounded-full border border-red-400/30 text-red-400';
                } else {
                    // Check which alert categories are selected
                    const selectedCategories = [];
                    ['weatherAlerts', 'navigationAlerts', 'securityAlerts', 'mechanicalAlerts'].forEach(alertType => {
                        const button = document.getElementById(alertType);
                        if (button && button.classList.contains('selected-alert')) {
                            selectedCategories.push(button.getAttribute('data-type'));
                        }
                    });
                    // If no categories are selected, show "Select alert categories" message
                    if (selectedCategories.length === 0) {
                        resultDiv.innerHTML = `
                            <div class="flex flex-col items-center justify-center py-6 text-ocean-300">
                                <i class="fas fa-filter mb-2 text-2xl"></i>
                                <p>Please select alert categories above</p>
                                <p class="text-sm text-ocean-400 mt-1">Choose from Weather, Navigation, Security, or Mechanical</p>
                            </div>
                        `;
                        document.getElementById('alertCount').textContent = '0';
                        document.getElementById('warningCount').textContent = '0';
                        document.getElementById('criticalCount').textContent = '0';
                        alertBadge.textContent = 'Select Categories';
                        alertBadge.className = 'text-xs px-2 py-1 bg-blue-500/20 rounded-full border border-blue-400/30 text-blue-400';
                        return;
                    }
                    // Generate alerts based on selected categories
                    let alertsToShow = [];
                    let warningCount = 0;
                    let criticalCount = 0;
                    if (selectedCategories.includes('weather')) {
                        alertsToShow.push(`
                            <div class="glass rounded-lg p-3 border-l-4 border-yellow-500">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-yellow-400 font-semibold text-xs">WEATHER WARNING</span>
                                    <span class="text-xs text-ocean-300">14:30 UTC</span>
                                </div>
                                <p class="text-ocean-100 text-sm">High winds (25-30 knots) expected in sector 7-9. Recommend reduced speed.</p>
                                <div class="flex items-center mt-2 text-xs text-ocean-300">
                                    <i class="fas fa-wind mr-1"></i>
                                    <span>Wind Speed: 28 knots</span>
                                </div>
                            </div>
                        `);
                        warningCount++;
                    }
                    if (selectedCategories.includes('navigation')) {
                        alertsToShow.push(`
                            <div class="glass rounded-lg p-3 border-l-4 border-orange-500">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-orange-400 font-semibold text-xs">NAVIGATION ALERT</span>
                                    <span class="text-xs text-ocean-300">12:45 UTC</span>
                                </div>
                                <p class="text-ocean-100 text-sm">Dense fog reported in approach channels. Visibility reduced to 0.5 nautical miles.</p>
                                <div class="flex items-center mt-2 text-xs text-ocean-300">
                                    <i class="fas fa-eye-slash mr-1"></i>
                                    <span>Visibility: 0.5 nm</span>
                                </div>
                            </div>
                        `);
                        warningCount++;
                        alertsToShow.push(`
                            <div class="glass rounded-lg p-3 border-l-4 border-blue-500">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-blue-400 font-semibold text-xs">TRAFFIC ALERT</span>
                                    <span class="text-xs text-ocean-300">16:20 UTC</span>
                                </div>
                                <p class="text-ocean-100 text-sm">Heavy traffic congestion at Port Mumbai. Expected delay: 2-3 hours.</p>
                                <div class="flex items-center mt-2 text-xs text-ocean-300">
                                    <i class="fas fa-ship mr-1"></i>
                                    <span>Queue: 12 vessels</span>
                                </div>
                            </div>
                        `);
                        warningCount++;
                    }
                    if (selectedCategories.includes('mechanical')) {
                        alertsToShow.push(`
                            <div class="glass rounded-lg p-3 border-l-4 border-purple-500">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-purple-400 font-semibold text-xs">MAINTENANCE</span>
                                    <span class="text-xs text-ocean-300">18:00 UTC</span>
                                </div>
                                <p class="text-ocean-100 text-sm">Engine temperature slightly elevated. Schedule maintenance check at next port.</p>
                                <div class="flex items-center mt-2 text-xs text-ocean-300">
                                    <i class="fas fa-thermometer-half mr-1"></i>
                                    <span>Temperature: 85°C</span>
                                </div>
                            </div>
                        `);
                        warningCount++;
                        alertsToShow.push(`
                            <div class="glass rounded-lg p-3 border-l-4 border-red-500">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-red-400 font-semibold text-xs">FUEL WARNING</span>
                                    <span class="text-xs text-ocean-300">20:15 UTC</span>
                                </div>
                                <p class="text-ocean-100 text-sm">Fuel consumption 15% higher than optimal. Consider route optimization.</p>
                                <div class="flex items-center mt-2 text-xs text-ocean-300">
                                    <i class="fas fa-gas-pump mr-1"></i>
                                    <span>Efficiency: 85%</span>
                                </div>
                            </div>
                        `);
                        criticalCount++;
                    }
                    if (selectedCategories.includes('security')) {
                        alertsToShow.push(`
                            <div class="glass rounded-lg p-3 border-l-4 border-red-600">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-red-500 font-semibold text-xs">SECURITY ALERT</span>
                                    <span class="text-xs text-ocean-300">22:30 UTC</span>
                                </div>
                                <p class="text-ocean-100 text-sm">Piracy risk elevated in coordinates 18°N, 69°E. Maintain safe distance from coast.</p>
                                <div class="flex items-center mt-2 text-xs text-ocean-300">
                                    <i class="fas fa-shield-alt mr-1"></i>
                                    <span>Risk Level: High</span>
                                </div>
                            </div>
                        `);
                        criticalCount++;
                    }
                    // Show filtered alerts
                    resultDiv.innerHTML = `
                        <div class="text-sm text-ocean-200 space-y-2 max-h-64 overflow-y-auto maritime-scrollbar pr-3">
                            ${alertsToShow.join('')}
                        </div>
                    `;
                    // Update counters
                    const totalAlerts = alertsToShow.length;
                    document.getElementById('alertCount').textContent = totalAlerts.toString();
                    document.getElementById('warningCount').textContent = warningCount.toString();
                    document.getElementById('criticalCount').textContent = criticalCount.toString();
                    alertBadge.textContent = `${totalAlerts} Active Alert${totalAlerts !== 1 ? 's' : ''}`;
                    alertBadge.className = totalAlerts > 0 ? 
                        'text-xs px-2 py-1 bg-orange-500/20 rounded-full border border-orange-400/30 text-orange-400' :
                        'text-xs px-2 py-1 bg-green-500/20 rounded-full border border-green-400/30 text-green-400';                    
                    // Trigger popup alerts if there are alerts to show
                    if (totalAlerts > 0) {
                        triggerAlertPopups(selectedCategories);
                    }                    
                    // Update main dashboard alert count
                    const mainAlertCount = document.getElementById('alertCount');
                    const alertCard = mainAlertCount.closest('.weather-card');
                    if (alertCard && totalAlerts > 0) {
                        const statusDiv = alertCard.querySelector('.text-green-400, .text-orange-400');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Monitoring';
                            statusDiv.className = statusDiv.className.replace('text-green-400', 'text-orange-400');
                        }
                    } else if (alertCard && totalAlerts === 0) {
                        const statusDiv = alertCard.querySelector('.text-green-400, .text-orange-400');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<i class="fas fa-check mr-1"></i>All Clear';
                            statusDiv.className = statusDiv.className.replace('text-orange-400', 'text-green-400');
                        }
                    }
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="text-red-400 flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Failed to load alerts
                    </div>
                `;
            } finally {
                button.innerHTML = '<i class="fas fa-search mr-2"></i>Scan for Alerts';
                button.disabled = false;
                window.scanButtonClicked = false; // Reset the flag
            }
        }
        // Map layer controls
        function toggleMapLayer(layerType) {
            const button = document.getElementById(layerType);
            if (!button) {
                console.error('Button not found for layer:', layerType);
                return;
            }            
            const isActive = button.classList.contains('border-cyan-500');            
            if (isActive) {
                // Deactivate layer
                button.classList.remove('border-cyan-500', 'bg-cyan-500/20');
                button.classList.add('border-gray-500/50');
                activeMapLayers = activeMapLayers.filter(l => l !== layerType);                
                // Remove layer-specific visual effects
                removeLayerEffects(layerType);
                // Layer deactivated                
            } else {
                // Activate layer
                button.classList.remove('border-gray-500/50');
                button.classList.add('border-cyan-500', 'bg-cyan-500/20');
                activeMapLayers.push(layerType);                
                // Add layer-specific visual effects
                addLayerEffects(layerType);
                // Layer activated
            }            
            // Update active layers counter
            const activeLayersElement = document.getElementById('activeLayers');
            if (activeLayersElement) {
                activeLayersElement.textContent = activeMapLayers.length;
                // Active layers count updated
            }            
            // Log layer status
            // Layer status updated
        }
        // Add visual effects for specific layer types
        function addLayerEffects(layerType) {
            const mapElement = document.getElementById('map');
            if (!mapElement) return;
            switch(layerType) {
                case 'weatherLayer':
                    addWeatherLayerEffects(mapElement);
                    break;
                case 'windLayer':
                    addWindLayerEffects(mapElement);
                    break;
                case 'waveLayer':
                    addWaveLayerEffects(mapElement);
                    break;
                case 'trafficLayer':
                    addTrafficLayerEffects(mapElement);
                    break;
                case 'safetyLayer':
                    addSafetyLayerEffects(mapElement);
                    break;
            }
        }
        // Remove visual effects for specific layer types
        function removeLayerEffects(layerType) {
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('Map element not found');
                return;
            }
            // Remove layer-specific overlays
            const existingOverlay = document.getElementById(`${layerType}Overlay`);
            if (existingOverlay) {
                existingOverlay.remove();
                // Overlay removed
            }            
            // Remove layer indicators by ID
            const indicatorId = `${layerType}Indicator`;
            const indicator = document.getElementById(indicatorId);
            if (indicator) {
                indicator.remove();
                // Indicator removed
            }
            // Remove Leaflet map layers if they exist
            if (window.map && map.getContainer()) {
                try {
                    if (layerType === 'weatherLayer' && window.weatherMapLayer) {
                        map.removeLayer(window.weatherMapLayer);
                        window.weatherMapLayer = null;
                        // Weather layer removed
                    }
                    if (layerType === 'windLayer' && window.windMapLayer) {
                        map.removeLayer(window.windMapLayer);
                        window.windMapLayer = null;
                        // Wind layer removed
                    }
                } catch (e) {
                    // Error removing layer
                }
            }
        }
        // Weather layer effects - DISABLED (no mock data)
        function addWeatherLayerEffects(mapElement) {
            showLayerNotification('Weather Layer Unavailable', 'Requires live API data - no mock overlays', 'warning');
        }
        // Wind layer effects
        function addWindLayerEffects(mapElement) {
            // Remove existing wind overlay
            removeLayerEffects('windLayer');            
            // Create wind overlay
            const windOverlay = document.createElement('div');
            windOverlay.id = 'windLayerOverlay';
            windOverlay.className = 'absolute inset-0 pointer-events-none';
            windOverlay.style.zIndex = '1000'; // Very high z-index to ensure it's above map tiles
            windOverlay.style.border = '3px solid rgba(6, 182, 212, 0.8)';
            windOverlay.style.borderRadius = '12px';            
            // Add wind direction arrows - deterministic positioning
            const arrowRotations = [45, 90, 135, 180, 225, 270, 315, 0, 60, 120, 240, 300, 30, 150, 210, 330, 75, 105];
            for (let i = 0; i < 18; i++) {
                const arrow = document.createElement('div');
                arrow.className = 'absolute text-cyan-300 opacity-90 font-bold';
                arrow.innerHTML = '➤';
                arrow.style.left = ((i * 5) % 90) + '%';
                arrow.style.top = ((i * 7) % 90) + '%';
                arrow.style.fontSize = '16px';
                arrow.style.transform = `rotate(${arrowRotations[i]}deg)`;
                arrow.style.animation = `pulse 2s ease-in-out infinite`;
                arrow.style.animationDelay = (i * 0.1) + 's';
                arrow.style.filter = 'drop-shadow(0 0 3px rgba(6, 182, 212, 0.8))';
                windOverlay.appendChild(arrow);
            }            
            // Add wind speed indicators - deterministic positioning
            const windSpeeds = ['12kt', '8kt', '15kt', '6kt', '18kt', '11kt'];
            const speedPositions = [[25, 30], [65, 20], [40, 65], [80, 50], [15, 75], [70, 80]];
            for (let i = 0; i < 6; i++) {
                const speed = document.createElement('div');
                speed.className = 'absolute text-cyan-200 text-xs font-bold bg-cyan-900/70 px-2 py-1 rounded';
                speed.innerHTML = windSpeeds[i];
                speed.style.left = speedPositions[i][0] + '%';
                speed.style.top = speedPositions[i][1] + '%';
                speed.style.animation = `pulse ${1.8 + (i % 2)}s ease-in-out infinite`;
                speed.style.animationDelay = (i * 0.3) + 's';
                windOverlay.appendChild(speed);
            }            
            // Add wind flow lines
            const windLines = document.createElement('div');
            windLines.className = 'absolute inset-0';
            windLines.style.background = `
                linear-gradient(45deg, transparent 48%, rgba(6, 182, 212, 0.4) 49%, rgba(6, 182, 212, 0.4) 51%, transparent 52%),
                linear-gradient(-45deg, transparent 48%, rgba(6, 182, 212, 0.3) 49%, rgba(6, 182, 212, 0.3) 51%, transparent 52%)
            `;
            windLines.style.backgroundSize = '25px 25px';
            windLines.style.animation = 'windFlow 3s linear infinite';
            windOverlay.appendChild(windLines);            
            mapElement.appendChild(windOverlay);            
            // Also add as a Leaflet pane if map is available (for better integration)
            if (window.map && map.getContainer()) {
                try {
                    // Create a custom pane for wind overlay with high z-index
                    if (!map.getPane('windPane')) {
                        map.createPane('windPane');
                        map.getPane('windPane').style.zIndex = 1000;
                        map.getPane('windPane').style.pointerEvents = 'none';
                    }                    
                    // Add wind layer as SVG overlay to ensure it stays on top
                    const bounds = map.getBounds();
                    const windSvgOverlay = L.svgOverlay(
                        '<svg><defs><pattern id="windPattern" patternUnits="userSpaceOnUse" width="20" height="20"><line x1="0" y1="10" x2="20" y2="10" stroke="#06b6d4" stroke-width="2" opacity="0.6"/></pattern></defs><rect width="100%" height="100%" fill="url(#windPattern)"/></svg>',
                        bounds,
                        { pane: 'windPane' }
                    );
                    windSvgOverlay.addTo(map);                    
                    // Store reference for removal
                    window.windMapLayer = windSvgOverlay;
                } catch (e) {
                    console.log('Could not add Leaflet wind layer:', e);
                }
            }            
            // Add a prominent visual indicator that the wind layer is active
            const indicator = document.createElement('div');
            indicator.id = 'windLayerIndicator';
            indicator.className = 'absolute top-2 right-2 bg-cyan-600 text-white px-3 py-2 rounded-lg text-sm font-bold';
            indicator.style.zIndex = '1001'; // Even higher z-index for indicator
            indicator.textContent = '💨 WIND LAYER ACTIVE';
            indicator.style.animation = 'pulse 2s ease-in-out infinite';
            indicator.style.boxShadow = '0 0 15px rgba(6, 182, 212, 0.8)';
            mapElement.appendChild(indicator);            
            // Show wind data notification
            showLayerNotification('Wind Layer Activated', '💨 Wind patterns and direction overlay enabled', 'success');
        }
        // Wave layer effects
        function addWaveLayerEffects(mapElement) {
            removeLayerEffects('waveLayer');            
            const waveOverlay = document.createElement('div');
            waveOverlay.id = 'waveLayerOverlay';
            waveOverlay.className = 'absolute inset-0 pointer-events-none z-10';
            waveOverlay.style.background = `
                repeating-linear-gradient(0deg, transparent, transparent 8px, rgba(14, 165, 233, 0.2) 8px, rgba(14, 165, 233, 0.2) 16px),
                repeating-linear-gradient(90deg, transparent, transparent 12px, rgba(6, 182, 212, 0.15) 12px, rgba(6, 182, 212, 0.15) 24px)
            `;
            waveOverlay.style.animation = 'waveMotion 6s ease-in-out infinite';            
            mapElement.appendChild(waveOverlay);
            showLayerNotification('Wave Layer Activated', '🌊 Wave height and sea state overlay enabled', 'success');
        }
        // Traffic layer effects
        function addTrafficLayerEffects(mapElement) {
            removeLayerEffects('trafficLayer');            
            const trafficOverlay = document.createElement('div');
            trafficOverlay.id = 'trafficLayerOverlay';
            trafficOverlay.className = 'absolute inset-0 pointer-events-none z-10';            
            // Add moving vessel indicators - deterministic positioning
            const vesselPositions = [[20, 30], [60, 15], [35, 70], [80, 45], [15, 85], [75, 25]];
            for (let i = 0; i < 6; i++) {
                const vessel = document.createElement('div');
                vessel.className = 'absolute w-3 h-3 bg-yellow-400 rounded-full';
                vessel.style.left = vesselPositions[i][0] + '%';
                vessel.style.top = vesselPositions[i][1] + '%';
                vessel.style.animation = `vesselMove ${8 + (i % 4)}s linear infinite`;
                vessel.style.animationDelay = (i * 0.5) + 's';
                trafficOverlay.appendChild(vessel);
            }            
            mapElement.appendChild(trafficOverlay);
            showLayerNotification('Traffic Layer Activated', '🚢 Vessel traffic and AIS data overlay enabled', 'info');
        }
        // Safety layer effects
        function addSafetyLayerEffects(mapElement) {
            removeLayerEffects('safetyLayer');            
            const safetyOverlay = document.createElement('div');
            safetyOverlay.id = 'safetyLayerOverlay';
            safetyOverlay.className = 'absolute inset-0 pointer-events-none z-10';            
            // Add safety zone indicators - deterministic positioning
            const safetyPositions = [[25, 35], [70, 20], [40, 75], [80, 60]];
            for (let i = 0; i < 4; i++) {
                const zone = document.createElement('div');
                zone.className = 'absolute border-2 border-red-400 border-dashed rounded-full opacity-60';
                zone.style.width = '60px';
                zone.style.height = '60px';
                zone.style.left = safetyPositions[i][0] + '%';
                zone.style.top = safetyPositions[i][1] + '%';
                zone.style.animation = `pulse 3s ease-in-out infinite`;
                zone.style.animationDelay = (i * 0.5) + 's';
                safetyOverlay.appendChild(zone);
            }            
            mapElement.appendChild(safetyOverlay);
            showLayerNotification('Safety Layer Activated', '⚠️ Safety zones and hazard areas overlay enabled', 'warning');
        }
        // Show layer activation notifications
        function showLayerNotification(title, message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-6 z-50 p-4 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 ${
                type === 'success' ? 'bg-green-600' : 
                type === 'warning' ? 'bg-yellow-600' : 
                type === 'error' ? 'bg-red-600' : 'bg-slate-700'
            } text-white max-w-sm`;            
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="mr-3 text-lg">
                        ${type === 'success' ? '✅' : type === 'warning' ? '⚠️' : type === 'error' ? '❌' : 'ℹ️'}
                    </div>
                    <div>
                        <div class="font-semibold">${title}</div>
                        <div class="text-sm opacity-90">${message}</div>
                    </div>
                </div>
            `;            
            document.body.appendChild(notification);            
            // Slide in
            setTimeout(() => notification.classList.remove('translate-x-full'), 100);            
            // Slide out and remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        // Global route settings object for easy access
        const routeSettings = {
            get fuelPrice() { return parseFloat(document.getElementById('fuelPrice').value); },
            get fuelConsumption() { return parseFloat(document.getElementById('fuelConsumption').value); },
            get speedLimit() { return parseInt(document.getElementById('speedLimit').value); },
            get sourcePort() { return document.getElementById('sourcePort').value; },
            get destinationPort() { return document.getElementById('destinationPort').value; }
        };

        // Speed slider update
        function updateSpeedSlider() {
            const slider = document.getElementById('speedLimit');
            const display = document.getElementById('speedValue');
            display.textContent = slider.value + ' kts';
        }
        // Timeline animation
        function animateTimeline() {
            const progress = document.getElementById('timelineProgress');
            let currentProgress = 25;            
            setInterval(() => {
                currentProgress += 0.5;
                if (currentProgress > 100) currentProgress = 0;
                progress.style.width = currentProgress + '%';
            }, 1000);
        }
        // Set timeline progress
        function setTimelineProgress(percent) {
            percent = Math.max(0, Math.min(100, percent));
            document.getElementById('timelineProgress').style.width = percent + '%';
            var indicator = document.querySelector('.timeline-current-indicator');
            if (indicator) {
                indicator.style.left = percent + '%';
            }
        }
        // Automatically sync indicator with progress bar
        function syncTimelineIndicator() {
            var progressBar = document.getElementById('timelineProgress');
            var indicator = document.querySelector('.timeline-current-indicator');
            if (!progressBar || !indicator) return;
            // Observe style changes
            var observer = new MutationObserver(function() {
                var width = progressBar.style.width;
                if (width && width.endsWith('%')) {
                    indicator.style.left = width;
                }
            });
            observer.observe(progressBar, { attributes: true, attributeFilter: ['style'] });
        }
        document.addEventListener('DOMContentLoaded', function() {
            syncTimelineIndicator();
        });
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Weather Engine Maritime - Initializing...');            
            // Show immediate fallback content
            setTimeout(() => {
                const loader = document.getElementById('mapLoader');
                const fallback = document.getElementById('mapFallback');
                
                // Show fallback immediately while map loads
                if (fallback) {
                    fallback.style.display = 'block';
                    fallback.classList.remove('hidden');
                }
            }, 100);            
            // Initialize all components with error handling
            try {
                initMap();
            } catch (error) {
                console.error('Map initialization failed:', error);
                showMapFallback();
            }            
            try {
                initWeatherChart();
                initPerformanceChart();
                initWeatherTrendChart();
                initFuelChart();
            } catch (error) {
                console.error('Chart initialization failed:', error);
            }            
            try {
                checkAPI();
                animateTimeline();
            } catch (error) {
                console.error('API/Timeline initialization failed:', error);
            }            
            // Port selection listeners
            document.getElementById('sourcePort').addEventListener('change', () => {
                updateRouteDisplay();
                updateAnalyticsDashboard(); // Sync analytics with route changes
                if (validateRouteSelection()) {
                    setTimeout(drawRoute, 500); // Give map time to be ready
                }
            });            
            document.getElementById('destinationPort').addEventListener('change', () => {
                updateRouteDisplay();
                updateAnalyticsDashboard(); // Sync analytics with route changes
                if (validateRouteSelection()) {
                    setTimeout(drawRoute, 500);
                }
            });            
            document.getElementById('updateRoute').addEventListener('click', () => {
                updateRouteDisplay();
                if (validateRouteSelection()) {
                    setTimeout(drawRoute, 500);
                }
            });
            // Action button listeners
            document.getElementById('loadForecast').addEventListener('click', loadForecast);
            document.getElementById('optimizeRoute').addEventListener('click', optimizeRoute);
            document.getElementById('loadAlerts').addEventListener('click', () => {
                window.scanButtonClicked = true; // Set flag to indicate scan button was clicked
                loadAlerts();
            });
            document.getElementById('refreshWeather').addEventListener('click', loadForecast);
            
            // Waypoint weather refresh listener
            document.getElementById('refreshWaypointWeatherMain').addEventListener('click', () => {
                if (waypointWeatherData.length > 0) {
                    const waypoints = waypointWeatherData.map(data => data.coordinates);
                    fetchWaypointWeather(waypoints);
                }
            });
            
            // Position toggle listener for alert popups
            document.getElementById('positionToggle').addEventListener('click', togglePopupPosition);            
            // Map control listeners
            document.getElementById('centerMap').addEventListener('click', () => {
                if (map) {
                    map.setView([15.0, 74.0], 6);
                } else {
                    console.log('Map not available, using fallback centering');
                }
            });            
            document.getElementById('fullscreen').addEventListener('click', () => {
                const mapContainer = document.getElementById('map');
                if (mapContainer && mapContainer.requestFullscreen) {
                    mapContainer.requestFullscreen();
                }
            });
            // Layer toggle listeners
            ['weatherLayer', 'windLayer', 'waveLayer', 'trafficLayer', 'safetyLayer'].forEach(layerId => {
                const button = document.getElementById(layerId);
                if (button) {
                    button.addEventListener('click', () => toggleMapLayer(layerId));
                }
            });
            // Alert type filter listeners
            ['weatherAlerts', 'navigationAlerts', 'securityAlerts', 'mechanicalAlerts'].forEach(alertType => {
                const button = document.getElementById(alertType);
                if (button) {
                    button.addEventListener('click', () => {
                        const checkmark = button.querySelector('.checkmark');
                        const selected = button.classList.contains('selected-alert');
                        if (!selected) {
                            button.classList.add('selected-alert', 'font-bold', 'border-2');
                            checkmark.classList.remove('hidden');
                        } else {
                            button.classList.remove('selected-alert', 'font-bold', 'border-2');
                            checkmark.classList.add('hidden');
                        }
                        // Don't call loadAlerts() here - only when scan button is clicked
                    });
                }
            });
            // Speed slider listener
            document.getElementById('speedLimit').addEventListener('input', () => {
                updateSpeedSlider();
                updateRouteDisplay(); // Update duration when speed changes
                updateAnalyticsDashboard(); // Sync analytics with speed changes
            });
            
            // Fuel price listener - sync with route calculations
            document.getElementById('fuelPrice').addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                if (value >= 400 && value <= 1200) {
                    e.target.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                    updateRouteDisplay(); // Update fuel cost when price changes
                    updateAnalyticsDashboard(); // Sync analytics with fuel price changes
                } else {
                    e.target.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                }
            });
            
            // Fuel consumption listener - sync with route calculations
            document.getElementById('fuelConsumption').addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                if (value >= 2000 && value <= 10000) {
                    e.target.style.borderColor = 'rgba(34, 197, 94, 0.5)';
                    updateRouteDisplay(); // Update fuel cost when consumption changes
                    updateAnalyticsDashboard(); // Sync analytics with fuel consumption changes
                } else {
                    e.target.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                }
            });            
            // Status refresh
            if (document.getElementById('refreshStatus')) {
                document.getElementById('refreshStatus').addEventListener('click', checkAPI);
            }            
            // Auto-refresh status every 30 seconds
            setInterval(checkAPI, 30000);            
            // Initialize displays
            updateSpeedSlider();
            updateRouteDisplay();
            updateAnalyticsDashboard(); // Initialize analytics with real route data
            console.log('Weather Engine Maritime - Initialization complete');
        });
        // Enhanced floating particles
        function createFloatingElement() {
            const element = document.createElement('div');
            element.className = 'floating-particles';
            
            // Use deterministic positioning based on current time
            const time = Date.now();
            const position = ((time / 1000) % 100);
            element.style.left = position + '%';
            element.style.animationDelay = ((time / 100) % 10) + 's';
            element.style.animationDuration = (((time / 200) % 10) + 15) + 's';            
            
            // Add different particle types - deterministic selection
            const types = ['💧', '🌊', '⭐', '✨'];
            const shouldShowIcon = ((time / 500) % 5) === 0;
            if (shouldShowIcon) {
                const typeIndex = Math.floor((time / 1000) % types.length);
                element.innerHTML = types[typeIndex];
                element.style.fontSize = '12px';
                element.style.background = 'transparent';
            }            
            document.body.appendChild(element);            
            // Remove element after animation
            setTimeout(() => {
                if (element.parentNode) {
                    element.parentNode.removeChild(element);
                }
            }, 25000);
        }
        // Create floating particles periodically
        setInterval(createFloatingElement, 2000);
        // Update vessel count - deterministic based on time
        setInterval(() => {
            const time = Date.now();
            const vesselCount = Math.floor(((time / 10000) % 5)) + 2;
            document.getElementById('visibleVessels').textContent = vesselCount;
        }, 10000);
        // Live India Time Display
        function updateIndiaTime() {
            const now = new Date();
            // Convert to India Standard Time (IST) - UTC+5:30
            const indiaTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
            const timeOptions = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true,
                timeZone: 'Asia/Kolkata'
            };
            const timeOptions24 = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
                timeZone: 'Asia/Kolkata'
            };
            const dateOptions = {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                timeZone: 'Asia/Kolkata'
            };
            const timeString = indiaTime.toLocaleTimeString('en-IN', timeOptions);
            const timeString24 = indiaTime.toLocaleTimeString('en-IN', timeOptions24);
            const dateString = indiaTime.toLocaleDateString('en-IN', dateOptions);
            // Update navigation time
            const liveTimeElement = document.getElementById('liveTime');
            if (liveTimeElement) {
                liveTimeElement.innerHTML = `
                    <div class="text-right">
                        <div class="font-bold text-ocean-100">${timeString}</div>
                        <div class="text-xs text-ocean-300">${dateString} IST</div>
                    </div>
                `;
            }
            // Update timeline time
            const timelineTimeElement = document.getElementById('timelineTime');
            if (timelineTimeElement) {
                timelineTimeElement.textContent = `${timeString24} IST`;
            }
        }
        // Update time immediately and then every second
        updateIndiaTime();
        setInterval(updateIndiaTime, 1000);
        // Enhanced Dynamic Background with Vanta.js
        let vantaEffect = null;
        function initializeBackground() {
            try {
                // Initialize Vanta.js WAVES effect for better visibility
                vantaEffect = VANTA.WAVES({
                    el: "#vanta-background",
                    mouseControls: true,
                    touchControls: true,
                    gyroControls: false,
                    minHeight: 200.00,
                    minWidth: 200.00,
                    scale: 1.00,
                    scaleMobile: 1.00,
                    color: 0x0e1e34,
                    shininess: 35.00,
                    waveHeight: 25.00,
                    waveSpeed: 0.75,
                    zoom: 0.65
                });
                console.log('WAVES effect initialized successfully');
            } catch (error) {
                console.log('Vanta.js WAVES not available, trying TOPOLOGY...');
                try {
                    // TOPOLOGY with transparent background and dark blue lines
                    vantaEffect = VANTA.TOPOLOGY({
                        el: "#vanta-background",
                        mouseControls: true,
                        touchControls: true,
                        gyroControls: false,
                        minHeight: 200.00,
                        minWidth: 200.00,
                        scale: 1.00,
                        scaleMobile: 1.00,
                        color: 0x224466,        // Subtle dark blue lines
                        backgroundColor: 0x00000000, // Fully transparent background
                        size: 1.20,              // Smaller wave size for more detail
                        spacing: 15.00           // Tighter spacing for more waves
                    });
                    console.log('TOPOLOGY effect initialized successfully');
                } catch (error2) {
                    console.log('Vanta.js TOPOLOGY not available, trying CELLS...');
                    try {
                        // Fallback to CELLS for similar low-poly effect
                        vantaEffect = VANTA.CELLS({
                            el: "#vanta-background",
                            mouseControls: true,
                            touchControls: true,
                            gyroControls: false,
                            minHeight: 200.00,
                            minWidth: 200.00,
                            scale: 1.00,
                            color1: 0x4a90e2,
                            color2: 0x6bb6ff,
                            size: 2.00,
                            speed: 1.50
                        });
                        console.log('CELLS effect initialized successfully');
                    } catch (error3) {
                        console.log('All Vanta.js effects failed, using CSS background');
                        document.getElementById('vanta-background').style.display = 'none';
                    }
                }
            }
        }
        // Initialize background when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for Vanta.js to load
            setTimeout(initializeBackground, 500);
        });
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (vantaEffect) vantaEffect.destroy();
        });

        // ========== OPENWEATHER API OVERLAY SYSTEM ==========

        // Fetch weather data from OpenWeather API for a specific coordinate
        async function fetchWeatherData(lat, lon) {
            try {
                const response = await fetch(`${OPENWEATHER_BASE_URL}/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return {
                    lat: lat,
                    lon: lon,
                    windSpeed: data.wind.speed, // m/s
                    windDirection: data.wind.deg,
                    waveHeight: data.main.humidity / 10, // Simulated wave height
                    temperature: data.main.temp,
                    pressure: data.main.pressure,
                    visibility: data.visibility / 1000, // Convert to km
                    weatherCondition: data.weather[0].main,
                    description: data.weather[0].description
                };
            } catch (error) {
                console.error('Error fetching weather data:', error);
                throw error; // No mock data - only real API data
            }
        }

        // Get color based on wind speed thresholds
        function getWindSpeedColor(windSpeed) {
            if (windSpeed <= WIND_THRESHOLDS.low) {
                return '#10B981'; // Green - Safe conditions
            } else if (windSpeed <= WIND_THRESHOLDS.medium) {
                return '#F59E0B'; // Yellow - Moderate conditions
            } else {
                return '#EF4444'; // Red - Dangerous conditions
            }
        }

        // Create weather overlay for waypoints on a specific route
        async function createWeatherOverlay(routeName) {
            if (!PREDEFINED_ROUTES[routeName]) {
                console.error('Route not found:', routeName);
                return;
            }

            const route = PREDEFINED_ROUTES[routeName];
            weatherOverlayData = [];
            
            // Clear existing overlay layers
            clearWeatherOverlay();

            // Show loading indicator
            showOverlayLoading(true);

            try {
                // Sample every 5th waypoint to avoid API rate limits
                const sampledWaypoints = route.waypoints.filter((_, index) => index % 5 === 0);
                
                for (let i = 0; i < sampledWaypoints.length; i++) {
                    const [lat, lon] = sampledWaypoints[i];
                    const weatherData = await fetchWeatherData(lat, lon);
                    weatherOverlayData.push(weatherData);

                    // Create stunning large colored circles with enhanced gradient effect
                    const color = getWindSpeedColor(weatherData.windSpeed);
                    
                    // Create multiple concentric circles for beautiful gradient effect
                    const baseRadius = 250000; // 250km base radius (much larger)
                    const circles = [];
                    
                    // Outermost circle (very light glow effect)
                    const glowCircle = L.circle([lat, lon], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.08,
                        radius: baseRadius * 1.2,
                        weight: 1,
                        opacity: 0.2,
                        className: 'glow-circle'
                    }).addTo(map);
                    circles.push(glowCircle);
                    
                    // Outer circle (light)
                    const outerCircle = L.circle([lat, lon], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.25,
                        radius: baseRadius,
                        weight: 2,
                        opacity: 0.4,
                        className: 'outer-circle'
                    }).addTo(map);
                    circles.push(outerCircle);
                    
                    // Middle circle (medium intensity)
                    const middleCircle = L.circle([lat, lon], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.45,
                        radius: baseRadius * 0.65, // 65% of base
                        weight: 3,
                        opacity: 0.6,
                        className: 'middle-circle'
                    }).addTo(map);
                    circles.push(middleCircle);
                    
                    // Inner circle (high intensity)
                    const innerCircle = L.circle([lat, lon], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.75,
                        radius: baseRadius * 0.35, // 35% of base
                        weight: 4,
                        opacity: 0.8,
                        className: 'inner-circle'
                    }).addTo(map);
                    circles.push(innerCircle);
                    
                    // Core circle (most intense with pulsing effect)
                    const coreCircle = L.circle([lat, lon], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.9,
                        radius: baseRadius * 0.15, // 15% of base
                        weight: 5,
                        opacity: 1.0,
                        className: 'core-circle pulse-animation'
                    }).addTo(map);
                    circles.push(coreCircle);

                    // Add popup to the core circle (most interactive)
                    coreCircle.bindPopup(`
                        <div class="weather-popup">
                            <h4 class="font-bold text-sm mb-2">Weather Conditions</h4>
                            <div class="text-xs space-y-1">
                                <div><strong>Wind:</strong> ${weatherData.windSpeed.toFixed(1)} m/s (${(weatherData.windSpeed * 1.944).toFixed(1)} kts)</div>
                                <div><strong>Direction:</strong> ${weatherData.windDirection.toFixed(0)}°</div>
                                <div><strong>Wave Height:</strong> ${weatherData.waveHeight.toFixed(1)}m</div>
                                <div><strong>Temperature:</strong> ${weatherData.temperature.toFixed(1)}°C</div>
                                <div><strong>Visibility:</strong> ${weatherData.visibility.toFixed(1)}km</div>
                                <div><strong>Condition:</strong> ${weatherData.description}</div>
                                <div class="mt-2 p-1 rounded text-center" style="background-color: ${color}; color: white;">
                                    <strong>${weatherData.windSpeed <= WIND_THRESHOLDS.low ? 'SAFE' : 
                                              weatherData.windSpeed <= WIND_THRESHOLDS.medium ? 'MODERATE' : 'DANGEROUS'}</strong>
                                </div>
                            </div>
                        </div>
                    `);

                    // Store all circles for this waypoint
                    circles.forEach(circle => overlayLayers.push(circle));

                    // Small delay to avoid overwhelming the API
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                overlayVisible = true;
                showOverlayLoading(false);
                updateOverlayLegend();
                console.log(`Weather overlay created for ${route.name} with ${weatherOverlayData.length} data points`);

            } catch (error) {
                console.error('Error creating weather overlay:', error);
                showOverlayLoading(false);
            }
        }

        // Clear all weather overlay layers
        function clearWeatherOverlay() {
            overlayLayers.forEach(layer => {
                map.removeLayer(layer);
            });
            overlayLayers = [];
            overlayVisible = false;
            hideOverlayLegend();
        }

        // Toggle weather overlay visibility
        function toggleWeatherOverlay() {
            if (overlayVisible) {
                clearWeatherOverlay();
            } else {
                const sourcePort = document.getElementById('sourcePort').value;
                const destPort = document.getElementById('destinationPort').value;
                const routeKey = `${sourcePort}_${destPort}`;
                
                if (PREDEFINED_ROUTES[routeKey]) {
                    createWeatherOverlay(routeKey);
                } else {
                    alert('Please generate a route first to view weather overlay');
                }
            }
        }

        // Show/hide loading indicator for overlay
        function showOverlayLoading(show) {
            // You can add a loading indicator in the UI here
            console.log(show ? 'Loading weather overlay...' : 'Weather overlay loaded');
        }

        // Update overlay legend
        function updateOverlayLegend() {
            const legendHtml = `
                <div class="weather-overlay-legend" style="position: absolute; top: 10px; right: 10px; background: rgba(15, 23, 42, 0.9); padding: 10px; border-radius: 8px; color: white; font-size: 12px; z-index: 1000;">
                    <h4 class="font-bold mb-2">Wind Speed Zones</h4>
                    <div class="space-y-1">
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-2" style="background-color: #10B981;"></div>
                            <span>Safe (0-${WIND_THRESHOLDS.low} m/s)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-2" style="background-color: #F59E0B;"></div>
                            <span>Moderate (${WIND_THRESHOLDS.low}-${WIND_THRESHOLDS.medium} m/s)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 rounded-full mr-2" style="background-color: #EF4444;"></div>
                            <span>Dangerous (${WIND_THRESHOLDS.medium}+ m/s)</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Add legend to map container
            const mapContainer = document.getElementById('map');
            const existingLegend = mapContainer.querySelector('.weather-overlay-legend');
            if (existingLegend) {
                existingLegend.remove();
            }
            mapContainer.insertAdjacentHTML('beforeend', legendHtml);
        }

        // Hide overlay legend
        function hideOverlayLegend() {
            const mapContainer = document.getElementById('map');
            const legend = mapContainer.querySelector('.weather-overlay-legend');
            if (legend) {
                legend.remove();
            }
        }

        // Update temperature overlay legend
        function updateTemperatureLegend() {
            const legendHtml = `
                <div class="weather-overlay-legend" style="position: absolute; top: 10px; right: 10px; background: rgba(15, 23, 42, 0.95); padding: 12px; border-radius: 8px; color: white; font-size: 12px; z-index: 1000; border: 2px solid #10B981;">
                    <h4 class="font-bold mb-2 text-green-400">🌡️ Temperature Zones</h4>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <div class="w-4 h-4 mr-2 rounded-full" style="background: #3B82F6;"></div>
                            <span>Cold (&lt;10°C)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 mr-2 rounded-full" style="background: #10B981;"></div>
                            <span>Cool (10-20°C)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 mr-2 rounded-full" style="background: #F59E0B;"></div>
                            <span>Warm (20-25°C)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 mr-2 rounded-full" style="background: #EF4444;"></div>
                            <span>Hot (25°C+)</span>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-300">
                        Click zones for detailed temperature data
                    </div>
                </div>
            `;
            
            const mapContainer = document.getElementById('map');
            const existingLegend = mapContainer.querySelector('.weather-overlay-legend');
            if (existingLegend) existingLegend.remove();
            mapContainer.insertAdjacentHTML('beforeend', legendHtml);
        }

        // Update precipitation overlay legend
        function updatePrecipitationLegend() {
            const legendHtml = `
                <div class="weather-overlay-legend" style="position: absolute; top: 10px; right: 10px; background: rgba(15, 23, 42, 0.95); padding: 12px; border-radius: 8px; color: white; font-size: 12px; z-index: 1000; border: 2px solid #6366F1;">
                    <h4 class="font-bold mb-2 text-purple-400">🌧️ Precipitation Zones</h4>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <div class="w-4 h-4 mr-2 rounded-full" style="background: #06B6D4;"></div>
                            <span>Light (&lt;30% intensity)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 mr-2 rounded-full" style="background: #3B82F6;"></div>
                            <span>Moderate (30-60% intensity)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 mr-2 rounded-full" style="background: #6366F1;"></div>
                            <span>Heavy (60%+ intensity)</span>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-300">
                        Based on cloud cover, humidity &amp; rain data<br>
                        Click zones for detailed weather info
                    </div>
                </div>
            `;
            
            const mapContainer = document.getElementById('map');
            const existingLegend = mapContainer.querySelector('.weather-overlay-legend');
            if (existingLegend) existingLegend.remove();
            mapContainer.insertAdjacentHTML('beforeend', legendHtml);
        }

        // Initialize map without overlay button on map
        document.addEventListener('DOMContentLoaded', function() {
            // Map initialization without overlay button
        });

        // Create temperature overlay with gradient zones
        async function createTemperatureOverlay(routeName) {
            if (!PREDEFINED_ROUTES[routeName]) {
                console.error('Route not found:', routeName);
                return;
            }

            const route = PREDEFINED_ROUTES[routeName];
            const sampledWaypoints = route.waypoints.filter((_, index) => index % 6 === 0);
            
            for (let i = 0; i < sampledWaypoints.length; i++) {
                const waypoint = sampledWaypoints[i];
                
                try {
                    await new Promise(resolve => setTimeout(resolve, 250));
                    
                    const response = await fetch(
                        `https://api.openweathermap.org/data/2.5/weather?lat=${waypoint[0]}&lon=${waypoint[1]}&appid=${OPENWEATHER_API_KEY}&units=metric`
                    );
                    
                    if (!response.ok) continue;
                    
                    const data = await response.json();
                    const temp = data.main.temp;
                    
                    // Temperature color coding
                    let tempColor, tempIntensity;
                    if (temp < 10) {
                        tempColor = '#3B82F6'; // Blue - Cold
                        tempIntensity = 'Cold';
                    } else if (temp < 20) {
                        tempColor = '#10B981'; // Green - Cool
                        tempIntensity = 'Cool';
                    } else if (temp < 25) {
                        tempColor = '#F59E0B'; // Yellow - Warm
                        tempIntensity = 'Warm';
                    } else {
                        tempColor = '#EF4444'; // Red - Hot
                        tempIntensity = 'Hot';
                    }
                    
                    // Create temperature zone circle
                    const tempCircle = L.circle([waypoint[0], waypoint[1]], {
                        radius: 180000, // 180km radius
                        fillColor: tempColor,
                        color: tempColor,
                        weight: 2,
                        opacity: 0.7,
                        fillOpacity: 0.3
                    }).addTo(map);
                    
                    // Add glow effect
                    const glowCircle = L.circle([waypoint[0], waypoint[1]], {
                        radius: 200000,
                        fillColor: tempColor,
                        color: tempColor,
                        weight: 1,
                        opacity: 0.4,
                        fillOpacity: 0.1
                    }).addTo(map);
                    
                    // Temperature popup
                    const popupContent = `
                        <div class="elegant-tooltip">
                            <h3 class="font-bold text-lg mb-2">🌡️ Temperature Zone</h3>
                            <div class="space-y-1">
                                <div><strong>Temperature:</strong> ${temp}°C</div>
                                <div><strong>Feels like:</strong> ${data.main.feels_like}°C</div>
                                <div><strong>Intensity:</strong> ${tempIntensity}</div>
                                <div><strong>Humidity:</strong> ${data.main.humidity}%</div>
                                <div><strong>Pressure:</strong> ${data.main.pressure} hPa</div>
                            </div>
                        </div>
                    `;
                    
                    tempCircle.bindPopup(popupContent);
                    tempOverlayLayers.push(tempCircle, glowCircle);
                    
                } catch (error) {
                    console.error('Error fetching temperature data:', error);
                }
            }
        }

        // Create precipitation overlay
        async function createPrecipitationOverlay(routeName) {
            if (!PREDEFINED_ROUTES[routeName]) {
                console.error('Route not found:', routeName);
                return;
            }

            const route = PREDEFINED_ROUTES[routeName];
            const sampledWaypoints = route.waypoints.filter((_, index) => index % 6 === 0);
            
            for (let i = 0; i < sampledWaypoints.length; i++) {
                const waypoint = sampledWaypoints[i];
                
                try {
                    await new Promise(resolve => setTimeout(resolve, 250));
                    
                    const response = await fetch(
                        `https://api.openweathermap.org/data/2.5/weather?lat=${waypoint[0]}&lon=${waypoint[1]}&appid=${OPENWEATHER_API_KEY}&units=metric`
                    );
                    
                    if (!response.ok) continue;
                    
                    const data = await response.json();
                    const clouds = data.clouds.all;
                    const humidity = data.main.humidity;
                    const rain = data.rain ? data.rain['1h'] || 0 : 0;
                    
                    // Calculate precipitation intensity from available data
                    let precipIntensity = Math.max(rain * 10, (clouds + humidity) / 20);
                    
                    // Always show zones - remove threshold
                    console.log(`Precipitation data for ${waypoint[0]} ${waypoint[1]}: clouds=${clouds}%, humidity=${humidity}%, rain=${rain}mm/h, intensity=${precipIntensity}`);
                    
                    // Precipitation color coding - lower thresholds for better visibility
                    let precipColor, precipLevel;
                    if (precipIntensity < 15) {
                        precipColor = '#06B6D4'; // Light blue - Light
                        precipLevel = 'Light';
                    } else if (precipIntensity < 35) {
                        precipColor = '#3B82F6'; // Blue - Moderate
                        precipLevel = 'Moderate';
                    } else {
                        precipColor = '#6366F1'; // Indigo - Heavy
                        precipLevel = 'Heavy';
                    }
                    
                    // Create precipitation zone
                    const precipCircle = L.circle([waypoint[0], waypoint[1]], {
                        radius: 150000, // 150km radius
                        fillColor: precipColor,
                        color: precipColor,
                        weight: 3,
                        opacity: 0.8,
                        fillOpacity: 0.4
                    }).addTo(map);
                    
                    // Add animated rain effect
                    const rainEffect = L.circle([waypoint[0], waypoint[1]], {
                        radius: 170000,
                        fillColor: precipColor,
                        color: precipColor,
                        weight: 1,
                        opacity: 0.3,
                        fillOpacity: 0.1,
                        className: 'pulse-animation'
                    }).addTo(map);
                    
                    // Precipitation popup
                    const popupContent = `
                        <div class="elegant-tooltip">
                            <h3 class="font-bold text-lg mb-2">🌧️ Precipitation Zone</h3>
                            <div class="space-y-1">
                                <div><strong>Intensity:</strong> ${precipLevel}</div>
                                <div><strong>Cloud Cover:</strong> ${clouds}%</div>
                                <div><strong>Humidity:</strong> ${humidity}%</div>
                                ${rain > 0 ? `<div><strong>Rain:</strong> ${rain}mm/h</div>` : ''}
                                <div><strong>Conditions:</strong> ${data.weather[0].description}</div>
                                <div><strong>Visibility:</strong> ${(data.visibility / 1000).toFixed(1)}km</div>
                            </div>
                        </div>
                    `;
                    
                    precipCircle.bindPopup(popupContent);
                    precipOverlayLayers.push(precipCircle, rainEffect);
                    
                } catch (error) {
                    console.error('Error fetching precipitation data:', error);
                }
            }
        }

        // Create elegant wind speed overlay with clean hover-based indicators
        async function createWindSpeedOverlay(routeName) {
            if (!PREDEFINED_ROUTES[routeName]) {
                console.error('Route not found:', routeName);
                return;
            }

            const route = PREDEFINED_ROUTES[routeName];
            clearAllOverlays();
            
            showOverlayLoading(true, 'wind');

            try {
                const sampledWaypoints = route.waypoints.filter((_, index) => index % 6 === 0);
                
                for (let i = 0; i < sampledWaypoints.length; i++) {
                    const [lat, lon] = sampledWaypoints[i];
                    const weatherData = await fetchWeatherData(lat, lon);

                    const windSpeed = weatherData.windSpeed;
                    const windDirection = weatherData.windDirection || 0;
                    const color = getWindSpeedColor(windSpeed);
                    
                    // Create subtle, clean wind indicator
                    const intensity = Math.min(windSpeed / 15, 1); // Normalize to 0-1
                    const size = 12 + (intensity * 8); // 12-20px based on intensity
                    
                    const windIcon = L.divIcon({
                        html: `
                            <div class="clean-wind-indicator" style="
                                width: ${size}px;
                                height: ${size}px;
                                position: relative;
                                cursor: pointer;
                            ">
                                <!-- Subtle pulsing circle -->
                                <div class="wind-pulse-ring" style="
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%);
                                    width: ${size * 2}px;
                                    height: ${size * 2}px;
                                    border: 2px solid ${color};
                                    border-radius: 50%;
                                    opacity: 0.3;
                                    animation: windRipple 2s ease-out infinite;
                                "></div>
                                
                                <!-- Main indicator dot -->
                                <div class="wind-dot" style="
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%);
                                    width: ${size}px;
                                    height: ${size}px;
                                    background: radial-gradient(circle, ${color} 0%, ${color}aa 70%, transparent 100%);
                                    border-radius: 50%;
                                    box-shadow: 0 0 ${size/2}px ${color}66;
                                    transition: all 0.3s ease;
                                "></div>
                                
                                <!-- Wind direction line (subtle) -->
                                <div class="wind-direction-line" style="
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    width: ${size * 1.5}px;
                                    height: 2px;
                                    background: linear-gradient(90deg, ${color}, transparent);
                                    transform: translate(-50%, -50%) rotate(${windDirection}deg);
                                    opacity: 0.6;
                                    transition: all 0.3s ease;
                                "></div>
                            </div>
                        `,
                        className: 'elegant-wind-marker',
                        iconSize: [size * 2, size * 2],
                        iconAnchor: [size, size]
                    });

                    const windMarker = L.marker([lat, lon], { icon: windIcon }).addTo(map);

                    // Enhanced hover popup with smooth animations
                    windMarker.bindTooltip(`
                        <div class="elegant-wind-tooltip" style="
                            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
                            color: white;
                            padding: 12px 16px;
                            border-radius: 12px;
                            border: 1px solid ${color}66;
                            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                            backdrop-filter: blur(10px);
                            font-size: 12px;
                            min-width: 200px;
                        ">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <div style="
                                    width: 8px;
                                    height: 8px;
                                    background: ${color};
                                    border-radius: 50%;
                                    margin-right: 8px;
                                    box-shadow: 0 0 8px ${color}66;
                                "></div>
                                <strong style="color: ${color};">Wind Conditions</strong>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                                <div><strong>Speed:</strong> ${windSpeed.toFixed(1)} m/s</div>
                                <div><strong>Knots:</strong> ${(windSpeed * 1.944).toFixed(1)} kts</div>
                                <div><strong>Direction:</strong> ${windDirection.toFixed(0)}°</div>
                                <div><strong>Cardinal:</strong> ${getWindDirectionName(windDirection)}</div>
                            </div>
                            <div style="
                                margin-top: 8px;
                                padding: 4px 8px;
                                background: ${color}22;
                                border-radius: 6px;
                                text-align: center;
                                font-weight: bold;
                                font-size: 10px;
                                color: ${color};
                            ">
                                ${getBeaufortScale(windSpeed)}
                            </div>
                        </div>
                    `, {
                        permanent: false,
                        direction: 'top',
                        offset: [0, -10],
                        className: 'elegant-tooltip'
                    });

                    windOverlayLayers.push(windMarker);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                windOverlayVisible = true;
                currentOverlayType = 'wind';
                showOverlayLoading(false, 'wind');
                updateCleanWindLegend();
                
            } catch (error) {
                console.error('Error creating wind overlay:', error);
                showOverlayLoading(false, 'wind');
            }
        }

        // Helper functions for wind data
        function getWindDirectionName(degrees) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            return directions[Math.round(degrees / 22.5) % 16];
        }

        function getBeaufortScale(windSpeed) {
            if (windSpeed < 0.3) return 'Force 0 (Calm)';
            if (windSpeed < 1.6) return 'Force 1 (Light Air)';
            if (windSpeed < 3.4) return 'Force 2 (Light Breeze)';
            if (windSpeed < 5.5) return 'Force 3 (Gentle Breeze)';
            if (windSpeed < 8.0) return 'Force 4 (Moderate Breeze)';
            if (windSpeed < 10.8) return 'Force 5 (Fresh Breeze)';
            if (windSpeed < 13.9) return 'Force 6 (Strong Breeze)';
            return 'Force 7+ (High Wind)';
        }

        function getSeaState(windSpeed) {
            if (windSpeed < 2) return 'Calm (0-0.1m waves)';
            if (windSpeed < 4) return 'Smooth (0.1-0.5m waves)';
            if (windSpeed < 6) return 'Slight (0.5-1.25m waves)';
            if (windSpeed < 8) return 'Moderate (1.25-2.5m waves)';
            return 'Rough (2.5m+ waves)';
        }

        // Clear all overlays
        function clearAllOverlays() {
            overlayLayers.forEach(layer => map.removeLayer(layer));
            windOverlayLayers.forEach(layer => map.removeLayer(layer));
            tempOverlayLayers.forEach(layer => map.removeLayer(layer));
            precipOverlayLayers.forEach(layer => map.removeLayer(layer));
            overlayLayers = [];
            windOverlayLayers = [];
            tempOverlayLayers = [];
            precipOverlayLayers = [];
            overlayVisible = false;
            windOverlayVisible = false;
            tempOverlayVisible = false;
            precipOverlayVisible = false;
            currentOverlayType = null;
            hideOverlayLegend();
        }

        // Update clean wind overlay legend
        function updateCleanWindLegend() {
            const legendHtml = `
                <div class="weather-overlay-legend" style="position: absolute; top: 10px; right: 10px; background: rgba(15, 23, 42, 0.95); padding: 12px; border-radius: 8px; color: white; font-size: 12px; z-index: 1000; border: 2px solid #F59E0B;">
                    <h4 class="font-bold mb-2 text-yellow-400">🌪️ Wind Indicators</h4>
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <div class="w-3 h-3 mr-2 rounded-full" style="background: radial-gradient(circle, #10B981 0%, #10B981aa 70%, transparent 100%); box-shadow: 0 0 6px #10B98166;"></div>
                            <span>Calm (0-${WIND_THRESHOLDS.low} m/s)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 mr-2 rounded-full" style="background: radial-gradient(circle, #F59E0B 0%, #F59E0Baa 70%, transparent 100%); box-shadow: 0 0 6px #F59E0B66;"></div>
                            <span>Moderate (${WIND_THRESHOLDS.low}-${WIND_THRESHOLDS.medium} m/s)</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 mr-2 rounded-full" style="background: radial-gradient(circle, #EF4444 0%, #EF4444aa 70%, transparent 100%); box-shadow: 0 0 6px #EF444466;"></div>
                            <span>Strong (${WIND_THRESHOLDS.medium}+ m/s)</span>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-300">
                        Hover over indicators for detailed wind data<br>
                        Dot size shows wind intensity
                    </div>
                </div>
            `;
            
            const mapContainer = document.getElementById('map');
            const existingLegend = mapContainer.querySelector('.weather-overlay-legend');
            if (existingLegend) existingLegend.remove();
            mapContainer.insertAdjacentHTML('beforeend', legendHtml);
        }

        // Enhanced loading indicator
        function showOverlayLoading(show, type = 'wave') {
            const button = document.querySelector(`#${type}OverlayBtn`);
            if (button) {
                if (show) {
                    button.innerHTML = `<i class="fas fa-spinner fa-spin text-sm"></i><span class="text-sm font-medium">Loading...</span>`;
                    button.style.pointerEvents = 'none';
                } else {
                    const icon = type === 'wind' ? 'fa-wind' : 'fa-water';
                    const text = type === 'wind' ? 'Wind Speed' : 'Wave Overlay';
                    button.innerHTML = `<i class="fas ${icon} text-sm"></i><span class="text-sm font-medium">${text}</span>`;
                    button.style.pointerEvents = 'auto';
                }
            }
        }

        // Button event handlers
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Wave overlay button
                document.getElementById('waveOverlayBtn')?.addEventListener('click', function() {
                    if (currentOverlayType === 'wave') {
                        clearAllOverlays();
                    } else {
                        const sourcePort = document.getElementById('sourcePort').value;
                        const destPort = document.getElementById('destinationPort').value;
                        const routeKey = `${sourcePort}_${destPort}`;
                        if (PREDEFINED_ROUTES[routeKey]) {
                            createWeatherOverlay(routeKey);
                        } else {
                            alert('Please generate a route first');
                        }
                    }
                });

                // Wind overlay button  
                document.getElementById('windOverlayBtn')?.addEventListener('click', function() {
                    if (currentOverlayType === 'wind') {
                        clearAllOverlays();
                    } else {
                        const sourcePort = document.getElementById('sourcePort').value;
                        const destPort = document.getElementById('destinationPort').value;
                        const routeKey = `${sourcePort}_${destPort}`;
                        if (PREDEFINED_ROUTES[routeKey]) {
                            createWindSpeedOverlay(routeKey);
                        } else {
                            alert('Please generate a route first');
                        }
                    }
                });

                // Temperature overlay button
                document.getElementById('tempOverlayBtn')?.addEventListener('click', function() {
                    if (currentOverlayType === 'temperature') {
                        clearAllOverlays();
                    } else {
                        clearAllOverlays();
                        const spinner = this.querySelector('.loading-spinner');
                        spinner.classList.remove('hidden');
                        this.disabled = true;
                        
                        createTemperatureOverlay('gopalpur_newharbour').then(() => {
                            tempOverlayVisible = true;
                            currentOverlayType = 'temperature';
                            updateTemperatureLegend();
                        }).catch(error => {
                            console.error('Error creating temperature overlay:', error);
                        }).finally(() => {
                            spinner.classList.add('hidden');
                            this.disabled = false;
                        });
                    }
                });

                // Precipitation overlay button
                document.getElementById('precipOverlayBtn')?.addEventListener('click', function() {
                    if (currentOverlayType === 'precipitation') {
                        clearAllOverlays();
                    } else {
                        clearAllOverlays();
                        const spinner = this.querySelector('.loading-spinner');
                        spinner.classList.remove('hidden');
                        this.disabled = true;
                        
                        createPrecipitationOverlay('gopalpur_newharbour').then(() => {
                            precipOverlayVisible = true;
                            currentOverlayType = 'precipitation';
                            updatePrecipitationLegend();
                        }).catch(error => {
                            console.error('Error creating precipitation overlay:', error);
                        }).finally(() => {
                            spinner.classList.add('hidden');
                            this.disabled = false;
                        });
                    }
                });

                // Clear all button
                document.getElementById('clearOverlayBtn')?.addEventListener('click', function() {
                    clearAllOverlays();
                });
            }, 1000);
        });

    </script>
</body>
</html>
